<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D-FIMS Core Next v4.2</title>
    <style>
        :root {
            --main: #00acc1; --bg: #f8f9fa; --nav: #212121; 
            --danger: #ff5252; --warn: #ff9800; --success: #4caf50;
            --card-radius: 14px; --panel-radius: 20px;
            --f-base: clamp(14px, 4vw, 18px);
            --grid-gap: 10px; --grid-cols: 2;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: #333; -webkit-tap-highlight-color: transparent; }
        body.modal-lock { overflow: hidden !important; touch-action: none; height: 100vh; }

        /* å¯¼èˆªç³»ç»Ÿ */
        .fims-nav { display: flex; background: var(--nav); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .nav-item { flex: 1; padding: 12px 2px; color: #888; border: none; background: none; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative; transition: 0.2s; }
        .nav-item.active { color: white; border-bottom: 3px solid var(--main); font-weight: bold; }
        .nav-badge { font-size: 0.65rem; opacity: 0.6; margin-top: 3px; font-weight: normal; }
        .sync-status { position: absolute; top: 8px; right: 20%; width: 6px; height: 6px; border-radius: 50%; background: #555; border: 1px solid #333; }

        /* æ£€ç´¢é¢æ¿ */
        .search-matrix-panel { background: white; width: 100%; overflow: hidden; display: none; border-bottom: 1px solid #eee; box-shadow: inset 0 -5px 15px rgba(0,0,0,0.02); padding-bottom: 15px; }
        .search-matrix-panel.open { display: block; animation: slideDown 0.25s ease-out; }
        @keyframes slideDown { from { max-height: 0; opacity: 0; } to { max-height: 550px; opacity: 1; } }
        .matrix-header { padding: 12px 15px 5px; display: flex; align-items: center; gap: 10px; }
        .matrix-search-box { flex: 1; background: #f0f2f5; border-radius: 10px; padding: 8px 12px; display: flex; align-items: center; }
        .matrix-input { border: none; background: transparent; width: 100%; outline: none; font-size: 0.85rem; margin-left: 8px; }
        .matrix-clear-btn { color: var(--main); font-size: 0.75rem; font-weight: bold; cursor: pointer; padding: 5px; }
        .matrix-section { padding: 8px 0 0 15px; }
        .matrix-label { font-size: 0.6rem; color: #bbb; margin-bottom: 4px; font-weight: 900; text-transform: uppercase; }
        .matrix-track { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 8px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .matrix-chip { background: white; border: 1px solid #eee; padding: 5px 12px; border-radius: 14px; font-size: 0.75rem; color: #555; white-space: nowrap; transition: 0.1s; display: flex; align-items: center; gap: 5px; }
        .matrix-chip.active { background: var(--main); color: white; border-color: var(--main); font-weight: bold; }
        .matrix-dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); }

        /* å¡ç‰‡ç³»ç»Ÿ */
        .fims-container { padding: var(--grid-gap); display: grid; gap: var(--grid-gap); align-content: start; }
        .view-inventory { grid-template-columns: repeat(var(--grid-cols), minmax(0, 1fr)); }
        .fims-card { border-radius: var(--card-radius); padding: 0.8rem; color: white; display: flex; flex-direction: column; box-shadow: 0 3px 10px rgba(0,0,0,0.06); transition: transform 0.1s; cursor: pointer; overflow: hidden; position: relative; container-type: inline-size; }
        .fims-card:active { transform: scale(0.96); }
        .card-content-layer { position: relative; z-index: 2; text-shadow: 0 1px 2px rgba(0,0,0,0.2); } 
        .card-brand { font-weight: 900; line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-type { opacity: 0.9; }
        .card-notes { font-size: 0.6rem; opacity: 0.85; margin-top: 5px; background: rgba(0,0,0,0.15); padding: 2px 6px; border-radius: 4px; align-self: flex-start; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .card-count { font-weight: 900; text-align: right; margin-top: auto; line-height: 1; }
        .card-count::after { content: 'å·'; font-size: 0.45em; margin-left: 2px; font-weight: normal; }
        .card-new-badge { position: absolute; top: 8px; right: 8px; z-index: 5; background: white; color: var(--danger); font-size: 0.55rem; font-weight: 900; padding: 1px 5px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* å¯†åº¦é€‚é… */
        .density-standard .fims-card { min-height: 125px; } .density-standard .card-brand { font-size: 1.1rem; } .density-standard .card-type { font-size: 0.8rem; } .density-standard .card-count { font-size: clamp(1.2rem, 16cqw, 2.2rem); }
        .density-compact .fims-card { min-height: 85px; padding: 0.6rem; } .density-compact .card-brand { font-size: 0.95rem; } .density-compact .card-type { font-size: 0.75rem; } .density-compact .card-notes { display: none !important; } .density-compact .card-count { font-size: clamp(1rem, 14cqw, 1.8rem); } .density-compact .card-new-badge { top: 5px; right: 5px; }
        .density-tiles .fims-card { aspect-ratio: 1/1; min-height: 0; justify-content: center; align-items: center; padding: 0.3rem; } .density-tiles .card-brand, .density-tiles .card-type, .density-tiles .card-notes { display: none !important; } .density-tiles .card-count { font-size: clamp(1rem, 25cqw, 2rem); margin: 0; width: 100%; text-align: center; } .density-tiles .card-new-badge { top: 4px; right: 4px; padding: 1px 4px; font-size: 0.5rem; }

        /* è®¾ç½®é¢æ¿ UI */
        .settings-block { background: white; border-radius: 18px; padding: 18px; margin-bottom: 12px; border: 1px solid #eee; }
        .settings-header { font-size: 0.95rem; font-weight: bold; margin-bottom: 12px; border-left: 4px solid var(--main); padding-left: 10px; }
        .control-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .grid-btn { padding: 10px 2px; border: 1px solid #f0f0f0; border-radius: 10px; text-align: center; font-size: 0.75rem; background: #fff; cursor: pointer; }
        .grid-btn.active { border-color: var(--main); background: #f0fbfc; color: var(--main); font-weight: bold; }
        
        .cloud-console { background: #f8f9fa; border-radius: 12px; padding: 12px; margin-top: 10px; border: 1px dashed #ddd; text-align: center; }
        .cloud-time { font-size: 0.7rem; color: #888; margin-bottom: 10px; font-family: monospace; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .cloud-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .cloud-btn { padding: 10px; border-radius: 10px; border: none; font-size: 0.8rem; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .cloud-btn-up { background: #e3f2fd; color: #1976d2; }
        .cloud-btn-down { background: #e8f5e9; color: #388e3c; }
        .cloud-btn:active { transform: scale(0.98); opacity: 0.8; }

        .btn-hold-reset { position: relative; overflow: hidden; background: white; border: 1.5px solid var(--danger); color: var(--danger); font-weight: bold; padding: 14px; border-radius: 12px; width: 100%; cursor: pointer; display: flex; justify-content: center; align-items: center; box-sizing: border-box; font-size: 0.9rem; }
        .hold-progress { position: absolute; top: 0; left: 0; bottom: 0; width: 0%; background: rgba(255, 82, 82, 0.15); }
        .hold-text { position: relative; z-index: 1; }

        .fab-group { position: fixed; bottom: 30px; right: 25px; z-index: 99; display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .fab { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 28px; box-shadow: 0 6px 15px rgba(0,0,0,0.15); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .fab-main { background: var(--main); }
        .fab-mini { width: 45px; height: 45px; font-size: 18px; background: white; color: #555; border: 1px solid #eee; }
        .fab-mini.active { background: var(--main); color: white; border-color: white; }

        .fims-portal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        .portal-content { background: white; width: 90%; max-width: 400px; border-radius: var(--panel-radius); max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
        .p-header { padding: 18px 20px 5px; flex-shrink: 0; }
        .p-body { padding: 10px 20px; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .p-footer { padding: 15px 20px; flex-shrink: 0; background: white; border-top: 1px solid #f5f5f5; }
        .fims-btn { padding: 14px; border-radius: 12px; border: none; font-size: 0.95rem; font-weight: bold; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; transition: 0.2s; box-sizing: border-box; }
        .btn-main { background: var(--main); color: white; }
        .btn-ghost { background: #f5f5f5; color: #666; }
        .btn-danger { background: var(--danger); color: white; }
        .form-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1.5px solid #eee; border-radius: 10px; box-sizing: border-box; background: #fafafa; font-size: 0.85rem; }
        .tag-row { display: flex; gap: 6px; margin: 5px 0 12px; overflow-x: auto; scrollbar-width: none; }
        .tag-pill { background: #f0f0f0; padding: 5px 10px; border-radius: 12px; font-size: 0.7rem; white-space: nowrap; border: 1px solid #e0e0e0; }
        .color-mode-bar { display: flex; background: #eee; padding: 4px; border-radius: 12px; margin-bottom: 12px; }
        .color-mode-btn { flex: 1; text-align: center; padding: 8px 0; font-size: 0.75rem; border-radius: 8px; cursor: pointer; color: #666; }
        .color-mode-btn.active { background: white; font-weight: bold; color: var(--main); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .fims-toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(33, 33, 33, 0.95); color: white; padding: 10px 20px; border-radius: 50px; font-size: 0.85rem; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 3000; opacity: 0; transition: 0.3s; pointer-events: none; }
        .fims-toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
    </style>
</head>
<body>

    <nav class="fims-nav">
        <button class="nav-item active" id="nav-sealed" onclick="Router.go('sealed')">æ€»åº“<span id="cnt-sealed" class="nav-badge">0</span><div id="sync-dot" class="sync-status"></div></button>
        <button class="nav-item" id="nav-inuse" onclick="Router.go('inuse')">ä½¿ç”¨<span id="cnt-inuse" class="nav-badge">0</span></button>
        <button class="nav-item" id="nav-opened" onclick="Router.go('opened')">å¤‡ç”¨<span id="cnt-opened" class="nav-badge">0</span></button>
        <button class="nav-item" id="nav-finished" onclick="Router.go('finished')">è®°å½•<span id="cnt-finished" class="nav-badge">0</span></button>
        <button class="nav-item" id="nav-settings" onclick="Router.go('settings')">è®¾ç½®</button>
    </nav>

    <div id="matrixPanel" class="search-matrix-panel">
        <div class="matrix-header">
            <div class="matrix-search-box"><span style="font-size:1rem; opacity:0.4">ğŸ”</span><input type="text" id="matrixInput" class="matrix-input" placeholder="è¾“å…¥å…³é”®å­—..." oninput="SearchEngine.onInput()"></div>
            <div class="matrix-clear-btn" onclick="SearchEngine.clear()">é‡ç½®</div>
        </div>
        <div class="matrix-section"><div class="matrix-label">å‚å®¶</div><div id="trackBrand" class="matrix-track"></div></div>
        <div class="matrix-section"><div class="matrix-label">æè´¨</div><div id="trackType" class="matrix-track"></div></div>
        <div class="matrix-section"><div class="matrix-label">é¢œè‰²</div><div id="trackColor" class="matrix-track"></div></div>
    </div>

    <div class="fab-group" id="fabGroup">
        <button class="fab fab-mini" id="fabSearch" onclick="SearchEngine.togglePanel()">ğŸ”</button>
        <button class="fab fab-main" onclick="InventoryUI.openAdd()">+</button>
    </div>

    <div id="app" class="fims-container"></div>

    <div id="entryPortal" class="fims-portal"><div class="portal-content"><div class="p-header"><div id="entryTitle" style="font-weight:bold; text-align:center;">ç™»è®°</div></div><div class="p-body"><label style="font-size:0.65rem; color:#999;">å“ç‰Œ</label><input type="text" id="inBrand" class="form-input"><div id="brandTags" class="tag-row"></div><label style="font-size:0.65rem; color:#999;">æè´¨</label><input type="text" id="inType" class="form-input"><div id="typeTags" class="tag-row"></div><div style="display:flex; gap:5px; margin-bottom:10px;"><div class="grid-btn active" id="mode-solid" onclick="InventoryUI.switchColorMode('solid')" style="flex:1">å•è‰²</div><div class="grid-btn" id="mode-gradient" onclick="InventoryUI.switchColorMode('gradient')" style="flex:1">æ¸å˜</div><div class="grid-btn" id="mode-dual" onclick="InventoryUI.switchColorMode('dual')" style="flex:1">åŒè‰²</div></div><div style="display:flex; gap:10px; margin-bottom:10px; align-items:center;"><input type="color" id="inColorPicker1" style="width:45px; height:40px; border:none; background:none;" value="#00acc1"><span id="colorJoin" style="display:none;">+</span><input type="color" id="inColorPicker2" style="width:45px; height:40px; border:none; background:none; display:none;" value="#ff4081"><div style="flex:1; font-size:0.75rem; color:#999; text-align:right;">ç‚¹å‡»é€‰æ‹©</div></div><label style="font-size:0.65rem; color:#999;">å¤‡æ³¨</label><input type="text" id="inNotes" class="form-input"><label style="font-size:0.65rem; color:#999;">æ•°é‡</label><input type="number" id="inCount" value="1" class="form-input"></div><div class="p-footer"><div style="display:flex; gap:10px;"><button class="fims-btn btn-ghost" onclick="Portal.closeAll()">æ”¾å¼ƒ</button><button class="fims-btn btn-main" onclick="InventoryUI.saveSubmit()">ä¿å­˜</button></div></div></div></div>
    <div id="warnPortal" class="fims-portal"><div class="portal-content" style="text-align:center;"><div class="p-header"><div id="warnIcon" style="font-size:40px">âš ï¸</div><div id="warnTitle" style="font-weight:bold; margin:5px 0;"></div></div><div class="p-body"><p id="warnMsg" style="color:#666; font-size:0.85rem; line-height:1.5;"></p></div><div class="p-footer"><div style="display:flex; gap:10px;"><button class="fims-btn btn-ghost" id="warnLBtn"></button><button class="fims-btn" id="warnRBtn"></button></div></div></div></div>
    <div id="finishPortal" class="fims-portal"><div class="portal-content" style="text-align:center;"><div class="p-header"><div style="font-size:40px">ğŸ“‰</div><div style="font-weight:bold; margin:5px 0;">æ ¸é”€</div></div><div class="p-footer"><div style="display:flex; gap:10px; margin-bottom:10px;"><button class="fims-btn btn-danger" onclick="HubUI.doFinish(true)">å…¨é¢æ ¸é”€</button><button class="fims-btn btn-main" onclick="HubUI.doFinish(false)">æ ¸é”€ 1 å·</button></div><button class="fims-btn btn-ghost" onclick="Portal.closeAll()">å–æ¶ˆ</button></div></div></div>
    <div id="hubPortal" class="fims-portal"><div class="portal-content"><div class="p-body" style="padding-top:15px;"><div id="hubCardArea"></div><div id="hubActionArea" style="display:flex; flex-direction:column; gap:8px; margin-top:15px;"></div><div class="control-grid" style="margin-top:15px; padding-top:12px; border-top:1px dashed #eee"><button class="grid-btn" onclick="HubUI.toEditMode()">âœ ä¿®è®¢</button><button class="grid-btn" style="color:var(--danger)" onclick="HubUI.requestDelete()">ğŸ—‘ï¸ åˆ é™¤</button></div></div><div class="p-footer"><button class="grid-btn" style="width:100%; padding:12px;" onclick="Portal.closeAll()">âœ–ï¸ å…³é—­</button></div></div></div>

    <input type="file" id="importInput" style="display:none" onchange="SyncCenter.importFile(this)">

<script>
    const Toast = { show(msg) { const div = document.createElement('div'); div.className = 'fims-toast'; div.innerText = msg; document.body.appendChild(div); requestAnimationFrame(() => div.classList.add('show')); setTimeout(() => { div.classList.remove('show'); setTimeout(() => div.remove(), 300); }, 2000); } };
    const Migrator = { fix(data) { const def = { inventory: { sealed: [], inuse: [], opened: [], finished: [] }, config: { brands: ['æ‹“ç«¹', 'è‰ºæ¾', 'JAYO', 'å“æ™®'], types: ['PLA', 'PETG', 'ABS'] }, settings: { columns: 2, density: 'standard', ghToken: '', ghRepo: '', sortOrder: 'count', lastSyncTime: 'ä»æœªåŒæ­¥' } }; if(!data.settings) data.settings = def.settings; if(!data.config) data.config = def.config; if(!data.inventory) data.inventory = def.inventory; if(!data.inventory.finished) data.inventory.finished = []; Object.keys(def.settings).forEach(k => { if(data.settings[k] === undefined) data.settings[k] = def.settings[k]; }); return data; } };
    let RAW_DB = JSON.parse(localStorage.getItem('FIMS_NEXT_DB'));
    let STATE = RAW_DB ? Migrator.fix(RAW_DB) : Migrator.fix({}); 

    /* v4.2 Cloud Engine: Fixed First-Run & Strict Timing */
    const SyncCenter = {
        setStatus(status) { const el = document.getElementById('sync-dot'); if(el) el.className = 'sync-status ' + status; },
        export() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(STATE)); a.download=`FIMS_${Date.now()}.json`; a.click(); },
        triggerImport() { document.getElementById('importInput').click(); },
        importFile(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if(data.inventory && data.settings) { Portal.closeAll(); document.body.removeAttribute('style'); requestAnimationFrame(() => { setTimeout(() => { STATE = Migrator.fix(data); Core.save(); Router.render(); Toast.show("å¯¼å…¥æˆåŠŸ"); }, 50); }); } else throw new Error(); } catch(err) { Toast.show("æ–‡ä»¶æ— æ•ˆ"); } }; reader.readAsText(file); input.value = ''; },
        
        async push() {
            const { ghToken: t, ghRepo: r } = STATE.settings;
            if(!t || !r) return Toast.show("è¯·å…ˆå¡«å†™ Token å’Œ ä»“åº“è·¯å¾„");
            this.setStatus('working'); Toast.show("â˜ï¸ æ­£åœ¨è¿æ¥äº‘ç«¯...");
            
            try {
                const url = `https://api.github.com/repos/${r}/contents/data.json`, headers = { 'Authorization': `token ${t}` };
                
                // 1. Check if file exists (Smart Create Logic)
                let sha = null;
                const checkRes = await fetch(url, { headers });
                if(checkRes.ok) {
                    const data = await checkRes.json();
                    sha = data.sha;
                } else if (checkRes.status !== 404) {
                    // If error is NOT 404, it's a permission error
                    throw new Error("Permission Denied");
                }

                // 2. Construct Payload
                const payload = {
                    message: "Manual Push via FIMS",
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(STATE))))
                };
                if(sha) payload.sha = sha; // Only add SHA if updating, omit for creating

                // 3. Perform PUT
                const res = await fetch(url, { method: 'PUT', headers, body: JSON.stringify(payload) });
                
                if(res.ok) { 
                    STATE.settings.lastSyncTime = new Date().toLocaleString(); // Only update local time on 200/201
                    // Don't call Core.save() here to avoid recursive autoCloud loop, just save to LS
                    localStorage.setItem('FIMS_NEXT_DB', JSON.stringify(STATE));
                    this.setStatus('active'); 
                    if(Router.activeTab === 'settings') SettingsUI.render(document.querySelector('.view-settings > div'));
                    Toast.show("âœ… ä¸Šä¼ æˆåŠŸ"); 
                } else {
                    throw new Error("Upload Failed");
                }
            } catch(e) { this.setStatus('error'); Toast.show("âŒ ä¸Šä¼ å¤±è´¥: è¯·æ£€æŸ¥ Token æƒé™"); }
        },

        async pull() {
            const { ghToken: t, ghRepo: r } = STATE.settings;
            if(!t || !r) return Toast.show("è¯·å…ˆå¡«å†™ Token å’Œ ä»“åº“è·¯å¾„");
            
            Portal.confirm("âš ï¸ é«˜å±æ“ä½œ", "äº‘ç«¯æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œä¸å¯æ’¤é”€ã€‚", "å–æ¶ˆ", Portal.closeWarn, "ç¡®å®šè¦†ç›–", async () => {
                Portal.closeAll(); 
                this.setStatus('working'); Toast.show("æ­£åœ¨æ‹‰å–æ•°æ®...");
                try {
                    const url = `https://api.github.com/repos/${r}/contents/data.json`, headers = { 'Authorization': `token ${t}` };
                    const res = await fetch(url, { headers });
                    if(res.ok) {
                        const json = await res.json();
                        const content = JSON.parse(decodeURIComponent(escape(window.atob(json.content))));
                        requestAnimationFrame(() => {
                            setTimeout(() => {
                                STATE = Migrator.fix(content);
                                Core.save(); // Save downloaded data
                                Router.render();
                                this.setStatus('active');
                                Toast.show("âœ… æ¢å¤æˆåŠŸ");
                            }, 50);
                        });
                    } else if (res.status === 404) {
                        Toast.show("âš ï¸ äº‘ç«¯æš‚æ— æ•°æ®");
                        this.setStatus('error');
                    } else throw new Error();
                } catch(e) { this.setStatus('error'); Toast.show("âŒ æ‹‰å–å¤±è´¥: Token é”™è¯¯"); }
            });
        },

        async autoCloud() { 
            const { ghToken: t, ghRepo: r } = STATE.settings; if(!t || !r) return;
            try { 
                const url = `https://api.github.com/repos/${r}/contents/data.json`, headers = { 'Authorization': `token ${t}` };
                let sha = null;
                const checkRes = await fetch(url, { headers });
                if(checkRes.ok) sha = (await checkRes.json()).sha;
                else if (checkRes.status !== 404) return; // Silent fail on permission error

                const payload = { message: "Auto Sync", content: btoa(unescape(encodeURIComponent(JSON.stringify(STATE)))) };
                if(sha) payload.sha = sha;

                const res = await fetch(url, { method: 'PUT', headers, body: JSON.stringify(payload) });
                if(res.ok) {
                    STATE.settings.lastSyncTime = new Date().toLocaleString();
                    localStorage.setItem('FIMS_NEXT_DB', JSON.stringify(STATE)); // Silent save
                    this.setStatus('active');
                    if(Router.activeTab === 'settings') SettingsUI.render(document.querySelector('.view-settings > div'));
                }
            } catch(e) { this.setStatus('error'); } 
        }
    };

    const Core = {
        save() { localStorage.setItem('FIMS_NEXT_DB', JSON.stringify(STATE)); document.documentElement.style.setProperty('--grid-cols', STATE.settings.columns); Router.updateCounts(); SyncCenter.autoCloud(); },
        moveItem(idx, from, to, all=false) { let item = STATE.inventory[from][idx]; let num = all ? item.count : 1; item.count -= num; if(item.count <= 0) STATE.inventory[from].splice(idx, 1); let newItem = { ...item, count: num }; if (to === 'finished') newItem.origin = from; else if (from === 'finished') { if (item.origin && ['sealed','inuse','opened'].includes(item.origin)) to = item.origin; delete newItem.origin; } let exist = STATE.inventory[to].find(i => i.brand === item.brand && i.type === item.type && i.notes === item.notes && i.color === item.color && i.color2 === item.color2 && i.colorMode === item.colorMode); if(exist) exist.count += num; else STATE.inventory[to].push(newItem); this.save(); Router.render(); Portal.closeAll(); },
        updateItem(idx, tab, newData) { STATE.inventory[tab][idx] = { ...STATE.inventory[tab][idx], ...newData }; this.save(); Router.render(); Portal.closeAll(); },
        deleteItem(idx, tab) { STATE.inventory[tab].splice(idx, 1); this.save(); Router.render(); Portal.closeAll(); }
    };

    const SearchEngine = {
        keyword: '', slots: { brand: null, type: null, color: null }, isOpen: false,
        togglePanel() { this.isOpen = !this.isOpen; document.getElementById('matrixPanel').classList.toggle('open', this.isOpen); if(this.isOpen) this.renderTracks(); },
        onInput() { this.keyword = document.getElementById('matrixInput').value.toLowerCase().trim(); Router.render(); this.renderTracks(); this.updateFabState(); },
        clear() { this.keyword = ''; document.getElementById('matrixInput').value = ''; this.slots = { brand: null, type: null, color: null }; Router.render(); this.renderTracks(); this.updateFabState(); },
        toggleFilter(type, value) { if (this.slots[type] === value) this.slots[type] = null; else this.slots[type] = value; Router.render(); this.renderTracks(); this.updateFabState(); },
        updateFabState() { document.getElementById('fabSearch').classList.toggle('active', !!(this.keyword || this.slots.brand || this.slots.type || this.slots.color)); },
        renderTracks() {
            const fullList = STATE.inventory[Router.activeTab];
            const getAvail = (slotToExclude) => {
                let filtered = fullList;
                if(this.keyword) { const tks = this.keyword.split(/\s+/); filtered = filtered.filter(i => tks.every(tk => `${i.brand} ${i.type} ${i.notes||''}`.toLowerCase().includes(tk))); }
                Object.keys(this.slots).forEach(s => { if (s !== slotToExclude && this.slots[s]) { if (s === 'color') filtered = filtered.filter(i => i.color === this.slots[s] || i.color2 === this.slots[s]); else filtered = filtered.filter(i => i[s] === this.slots[s]); } });
                return filtered;
            };
            const build = (id, slotKey, type) => {
                const items = getAvail(slotKey); const track = document.getElementById(id); track.innerHTML = '';
                const uniques = type === 'color' ? items.reduce((acc, i) => { if(!acc.find(c=>c.c===i.color && c.m===i.colorMode && c.c2===i.color2)) acc.push({c:i.color, c2:i.color2, m:i.colorMode}); return acc; }, []) : [...new Set(items.map(i => i[type]))].sort();
                uniques.forEach(it => {
                    const val = type === 'color' ? it.c : it;
                    const chip = document.createElement('div'); chip.className = `matrix-chip ${this.slots[slotKey] === val ? 'active' : ''}`;
                    if(type==='color') chip.innerHTML = `<span class="matrix-dot" style="background:${InventoryUI.getBackgroundStyle(it.m, it.c, it.c2)}"></span>`; else chip.innerText = val;
                    chip.onclick = () => this.toggleFilter(slotKey, val); track.appendChild(chip);
                });
                track.parentElement.style.display = uniques.length === 0 ? 'none' : 'block';
            };
            build('trackBrand', 'brand', 'brand'); build('trackType', 'type', 'type'); build('trackColor', 'color', 'color');
        },
        process(fullList) {
            let list = fullList;
            if (this.keyword) { const tks = this.keyword.split(/\s+/); list = list.filter(i => tks.every(tk => `${i.brand} ${i.type} ${i.notes||''}`.toLowerCase().includes(tk))); }
            if (this.slots.brand) list = list.filter(i => i.brand === this.slots.brand);
            if (this.slots.type) list = list.filter(i => i.type === this.slots.type);
            if (this.slots.color) list = list.filter(i => i.color === this.slots.color || i.color2 === this.slots.color2);
            return list;
        }
    };
    const Router = {
        activeTab: 'sealed',
        go(tab) { this.activeTab = tab; document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active')); document.getElementById('nav-' + tab).classList.add('active'); SearchEngine.isOpen = false; document.getElementById('matrixPanel').classList.remove('open'); SearchEngine.clear(); this.render(); },
        render() { const app = document.getElementById('app'); app.className = `fims-container view-${this.activeTab === 'settings' ? 'settings' : 'inventory'} density-${STATE.settings.density}`; document.getElementById('fabGroup').style.display = this.activeTab === 'settings' ? 'none' : 'flex'; const frag = document.createDocumentFragment(); if (this.activeTab === 'settings') { const wrapper = document.createElement('div'); SettingsUI.render(wrapper); frag.appendChild(wrapper); } else { InventoryUI.render(frag, this.activeTab); } app.innerHTML = ''; app.appendChild(frag); this.updateCounts(); },
        updateCounts() { ['sealed','inuse','opened','finished'].forEach(k => { const el = document.getElementById('cnt-'+k); if(el) el.innerText = STATE.inventory[k].reduce((s,i)=>s+(parseInt(i.count)||0), 0); }); }
    };
    const InventoryUI = {
        editMode: false, editIdx: null, currentColorMode: 'solid',
        render(container, tab) {
            let list = SearchEngine.process([...STATE.inventory[tab]]);
            list.sort((a,b) => STATE.settings.sortOrder==='count' ? b.count - a.count : (a.brand||'').localeCompare(b.brand||''));
            list.forEach((item) => {
                const realIdx = STATE.inventory[tab].indexOf(item);
                const card = document.createElement('div'); card.className = 'fims-card';
                card.style.background = this.getBackgroundStyle(item.colorMode, item.color, item.color2);
                let badge = item.isNew ? `<div class="card-new-badge">NEW</div>` : '';
                const notesHtml = item.notes ? `<div class="card-notes"># ${item.notes}</div>` : '';
                card.innerHTML = `${badge}<div class="card-content-layer"><div class="card-brand">${item.brand}</div><div class="card-type">${item.type}</div>${notesHtml}<div class="card-count">${item.count}</div></div>`;
                card.onclick = () => HubUI.open(realIdx, tab); container.appendChild(card);
            });
            if(list.length === 0) container.innerHTML = '<div style="text-align:center;padding:100px 40px;color:#ccc;width:100%;font-weight:bold;">ç©ºç©ºå¦‚ä¹Ÿ</div>';
        },
        getBackgroundStyle(mode, c1, c2) { if(mode === 'gradient') return `linear-gradient(135deg, ${c1}, ${c2})`; if(mode === 'dual') return `linear-gradient(90deg, ${c1} 50%, ${c2} 50%)`; return c1; },
        switchColorMode(mode) { this.currentColorMode = mode; document.querySelectorAll('#entryPortal .grid-btn').forEach(b => b.classList.remove('active')); document.getElementById('mode-'+mode).classList.add('active'); document.getElementById('inColorPicker2').style.display = (mode==='solid') ? 'none':'block'; document.getElementById('colorJoin').style.display = (mode==='solid') ? 'none':'block'; },
        openAdd() { this.editMode = false; document.getElementById('entryTitle').innerText = 'è€—æå…¥åº“ç™»è®°'; ['inBrand','inType','inNotes'].forEach(id=>document.getElementById(id).value=''); document.getElementById('inCount').value = 1; document.getElementById('inColorPicker1').value = '#00acc1'; document.getElementById('inColorPicker2').value = '#ff4081'; this.switchColorMode('solid'); this.renderTagCloud(); Portal.open('entryPortal'); },
        renderTagCloud() { const build = (cat, list, elId) => { document.getElementById(elId).innerHTML = list.map(v => `<div class="tag-pill" id="tag-${cat}-${v}">${v}</div>`).join('') + `<div class="tag-pill" style="color:var(--main); border-style:dashed" onclick="InventoryUI.newTag('${cat}')">+</div>`; list.forEach(v => { const el = document.getElementById(`tag-${cat}-${v}`); let timer; el.ontouchstart = () => { timer = setTimeout(() => Portal.confirm("ç§»é™¤æ ‡ç­¾", `ç¡®å®šåˆ é™¤ [${v}]ï¼Ÿ`, "å–æ¶ˆ", Portal.closeWarn, "ç§»é™¤", () => { STATE.config[cat === 'Brand' ? 'brands' : 'types'].splice(list.indexOf(v), 1); Core.save(); InventoryUI.renderTagCloud(); Portal.closeWarn(); }), 750); }; el.ontouchend = () => { clearTimeout(timer); if(timer) document.getElementById('in'+cat).value = v; }; }); }; build('Brand', STATE.config.brands, 'brandTags'); build('Type', STATE.config.types, 'typeTags'); },
        newTag(cat) { const v = prompt("æ–°æ ‡ç­¾åç§°:"); if(v){ STATE.config[cat==='Brand'?'brands':'types'].push(v); Core.save(); this.renderTagCloud(); } },
        saveSubmit() {
            const b = document.getElementById('inBrand').value.trim(), t = document.getElementById('inType').value.trim(), nts = document.getElementById('inNotes').value.trim(), c1 = document.getElementById('inColorPicker1').value, c2 = document.getElementById('inColorPicker2').value, n = parseInt(document.getElementById('inCount').value);
            if(!b || !t) return;
            if(!STATE.config.brands.includes(b)) STATE.config.brands.push(b); if(!STATE.config.types.includes(t)) STATE.config.types.push(t);
            const newData = { brand: b, type: t, color: c1, color2: c2, colorMode: this.currentColorMode, count: n, notes: nts };
            if(this.editMode) { Core.updateItem(this.editIdx, Router.activeTab, newData); } else { ['sealed','inuse','opened'].forEach(k => STATE.inventory[k].forEach(i => delete i.isNew)); newData.isNew = true; let exist = STATE.inventory.sealed.find(i => i.brand === b && i.type === t && i.color === c1 && i.color2 === c2 && i.colorMode === this.currentColorMode && i.notes === nts); if(exist) { exist.count += n; exist.isNew = true; } else STATE.inventory.sealed.push(newData); Core.save(); Router.render(); Portal.closeAll(); }
        }
    };
    const HubUI = {
        activeIdx: null, activeTab: null,
        open(idx, tab) { this.activeIdx = idx; this.activeTab = tab; const item = STATE.inventory[tab][idx]; const bg = InventoryUI.getBackgroundStyle(item.colorMode, item.color, item.color2); const badge = item.isNew ? `<div class="card-new-badge">NEW</div>` : ''; document.getElementById('hubCardArea').innerHTML = `<div class="fims-card density-standard" style="background:${bg}; cursor:default;">${badge}<div class="card-content-layer"><div class="card-brand">${item.brand}</div><div class="card-type">${item.type}</div>${item.notes?`<div class="card-notes"># ${item.notes}</div>`:''}<div class="card-count">${item.count}</div></div></div>`; let btns = ''; if(tab === 'sealed') btns = `<button class="fims-btn btn-main" onclick="HubUI.checkUnseal(${idx})">å‡ºåº“å¼€å¯</button>`; else if(tab === 'inuse') btns = `<button class="fims-btn btn-main" onclick="Core.moveItem(${idx},'inuse','opened')">å–ä¸‹å¤‡ç”¨</button><button class="fims-btn btn-danger" onclick="HubUI.openFinishModal()">è€—å°½æ ¸é”€</button>`; else if(tab === 'opened') btns = `<button class="fims-btn btn-main" onclick="Core.moveItem(${idx},'opened','inuse')">ä¸ŠæœºåŠ è½½</button><button class="fims-btn btn-danger" onclick="HubUI.openFinishModal()">è€—å°½æ ¸é”€</button>`; else if(tab === 'finished') btns = `<button class="fims-btn btn-main" onclick="Core.moveItem(${idx},'finished','sealed')">æ¢å¤åº“å­˜</button>`; document.getElementById('hubActionArea').innerHTML = btns; Portal.open('hubPortal'); },
        checkUnseal(idx) { const item = STATE.inventory.sealed[idx]; const inUseCount = STATE.inventory.inuse.filter(i => i.brand === item.brand && i.type === item.type && i.color === item.color).reduce((s,i)=>s+i.count,0); const openedCount = STATE.inventory.opened.filter(i => i.brand === item.brand && i.type === item.type && i.color === item.color).reduce((s,i)=>s+i.count,0); if (inUseCount > 0 || openedCount > 0) Portal.confirm("é‡å¤æé†’", `åŒè§„æ ¼å·²åœ¨åº“ï¼šä½¿ç”¨ä¸­ ${inUseCount} | å¤‡ç”¨ ${openedCount}\nç¡®å®šå¼€å¯æ–°å·ï¼Ÿ`, "å–æ¶ˆ", Portal.closeWarn, "ç¡®å®šå¼€å¯", () => Core.moveItem(idx, 'sealed', 'inuse')); else Core.moveItem(idx, 'sealed', 'inuse'); },
        openFinishModal() { Portal.open('finishPortal'); }, doFinish(all) { Core.moveItem(this.activeIdx, this.activeTab, 'finished', all); }, requestDelete() { Portal.confirm("åˆ é™¤", "æ°¸ä¹…åˆ é™¤æ­¤è®°å½•ï¼Ÿ", "å–æ¶ˆ", Portal.closeWarn, "åˆ é™¤", () => Core.deleteItem(this.activeIdx, this.activeTab)); },
        toEditMode() { Portal.closeAll(); const item = STATE.inventory[this.activeTab][this.activeIdx]; InventoryUI.editMode = true; InventoryUI.editIdx = this.activeIdx; document.getElementById('entryTitle').innerText = 'ä¿®è®¢èµ„æ–™'; document.getElementById('inBrand').value = item.brand; document.getElementById('inType').value = item.type; document.getElementById('inNotes').value = item.notes || ''; document.getElementById('inColorPicker1').value = item.color; if(item.color2) document.getElementById('inColorPicker2').value = item.color2; document.getElementById('inCount').value = item.count; InventoryUI.switchColorMode(item.colorMode || 'solid'); InventoryUI.renderTagCloud(); setTimeout(() => Portal.open('entryPortal'), 50); }
    };
    /* v4.2 Fixed Settings UI: No Auto-Sync on Input */
    const SettingsUI = {
        holdTimer: null, holdProgress: 0,
        render(app) { 
            app.innerHTML = `
                <div class="settings-block"><div class="settings-header">ç•Œé¢åˆ—æ•°</div><div class="control-grid">${[1,2,3,4,5,6].map(n=>`<div class="grid-btn ${STATE.settings.columns==n?'active':''}" onclick="SettingsUI.updateCols(${n})">${n}åˆ—</div>`).join('')}</div></div>
                <div class="settings-block"><div class="settings-header">è§†è§‰å¯†åº¦</div><div class="control-grid">${['standard','compact','tiles'].map(d=>`<div class="grid-btn ${STATE.settings.density==d?'active':''}" onclick="SettingsUI.updateDensity('${d}')">${d==='tiles'?'è‰²å—':d==='compact'?'ç´§å‡‘':'æ ‡å‡†'}</div>`).join('')}</div></div>
                
                <div class="settings-block">
                    <div class="settings-header">äº‘ç«¯åŒæ­¥ (GitHub)</div>
                    <input type="password" id="ghToken" class="form-input" value="${STATE.settings.ghToken}" placeholder="GitHub Token" onchange="STATE.settings.ghToken=this.value">
                    <input type="text" id="ghRepo" class="form-input" value="${STATE.settings.ghRepo}" placeholder="ä»“åº“è·¯å¾„ (user/repo)" onchange="STATE.settings.ghRepo=this.value">
                    
                    <div class="cloud-console">
                        <div class="cloud-time">ğŸ•’ æœ€è¿‘åŒæ­¥: ${STATE.settings.lastSyncTime || 'æœªåŒæ­¥'}</div>
                        <div class="cloud-actions">
                            <button class="cloud-btn cloud-btn-up" onclick="SyncCenter.push()"><span>â˜ï¸â¬†ï¸</span><span>ä¸Šä¼ äº‘ç«¯</span></button>
                            <button class="cloud-btn cloud-btn-down" onclick="SyncCenter.pull()"><span>â˜ï¸â¬‡ï¸</span><span>æ‹‰å–å›åœ°</span></button>
                        </div>
                    </div>
                </div>

                <div class="settings-block"><div class="settings-header">æ•°æ®ç®¡ç†</div><button class="fims-btn btn-ghost" onclick="SyncCenter.export()" style="margin-bottom:8px;">å¤‡ä»½å­˜æ¡£</button><button class="fims-btn btn-ghost" onclick="SyncCenter.triggerImport()">å¯¼å…¥å­˜æ¡£</button></div>
                <div class="settings-block"><div class="settings-header">ç»´æŠ¤</div><div class="btn-hold-reset" onmousedown="SettingsUI.startHold()" ontouchstart="SettingsUI.startHold()" onmouseup="SettingsUI.endHold()" ontouchend="SettingsUI.endHold()"><div id="holdBar" class="hold-progress"></div><span class="hold-text">é‡ç½®ç³»ç»Ÿ</span></div></div>
            `; 
        },
        updateCols(n) { STATE.settings.columns = n; Core.save(); Router.render(); },
        updateDensity(d) { STATE.settings.density = d; Core.save(); Router.render(); },
        startHold() { this.holdProgress = 0; this.holdTimer = setInterval(() => { this.holdProgress += 2; document.getElementById('holdBar').style.width = this.holdProgress + '%'; if(this.holdProgress >= 100) { this.endHold(); Portal.confirm("è­¦å‘Š", "æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ", "å–æ¶ˆ", Portal.closeWarn, "é‡ç½®", () => { localStorage.clear(); location.reload(); }); } }, 20); },
        endHold() { clearInterval(this.holdTimer); if(document.getElementById('holdBar')) document.getElementById('holdBar').style.width = '0%'; }
    };
    const Portal = {
        open(id) { document.getElementById(id).style.display = 'flex'; document.body.classList.add('modal-lock'); },
        closeAll() { document.querySelectorAll('.fims-portal').forEach(p => p.style.display = 'none'); document.body.classList.remove('modal-lock'); document.body.removeAttribute('style'); },
        closeWarn() { this.closeAll(); },
        confirm(t, m, lT, lF, rT, rF) { document.getElementById('warnTitle').innerText = t; document.getElementById('warnMsg').innerText = m; const lB = document.getElementById('warnLBtn'), rB = document.getElementById('warnRBtn'); lB.innerText = lT; lB.className = "fims-btn btn-ghost"; lB.onclick = lF; rB.innerText = rT; rB.className = rT ? "fims-btn btn-danger" : "fims-btn btn-ghost"; if(rT) { rB.style.display='flex'; rB.onclick = rF; } else rB.style.display='none'; this.open('warnPortal'); }
    };
    
    document.documentElement.style.setProperty('--grid-cols', STATE.settings.columns);
    Router.updateCounts();
    Router.go('sealed');
</script>
</body>
</html>
