<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D-FIMS æ‰“å°è€—æç®¡ç†ç³»ç»Ÿ - v66</title>
    <style>
        :root {
            --main: #00acc1; --bg: #f8f9fa; --nav: #212121; --danger: #ff5252; --warn: #ff9800; --success: #4caf50;
            --f-base: clamp(14px, 4vw, 18px);
            --f-card: clamp(16px, 4.5vw, 22px);
            --grid-cols: 2; 
        }
        body { font-family: 'Segoe UI', 'PingFang SC', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; font-size: var(--f-base); -webkit-tap-highlight-color: transparent; color: #333; }
        
        /* å¯¼èˆªç³»ç»Ÿ */
        .tabs { display: flex; background: var(--nav); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .tab-btn { flex: 1; padding: 14px 2px; color: #888; border: none; background: none; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .tab-btn.active { color: white; border-bottom: 3px solid var(--main); font-weight: bold; }
        .tab-count { font-size: 0.7rem; margin-top: 2px; opacity: 0.7; }

        /* æç®€æœç´¢æ  */
        .search-container { background: white; padding: 8px 12px; position: sticky; top: 58px; z-index: 90; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .search-row { display: flex; gap: 8px; align-items: center; }
        .search-input { flex: 1; padding: 8px 15px; border: 1.5px solid #eee; border-radius: 20px; font-size: 0.85rem; outline: none; background: #fafafa; }
        .filter-toggle { width: 36px; height: 36px; border-radius: 10px; border: 1.5px solid #eee; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; cursor: pointer; background: #fff; transition: all 0.2s; }
        .filter-toggle.active { border-color: var(--main); color: var(--main); background: #f0fbfc; }
        
        /* ç²¾ç®€ç­›é€‰æ‰˜ç›˜ */
        .filter-tray { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: #fff; border-radius: 0 0 12px 12px; }
        .filter-tray.active { max-height: 120px; padding-top: 10px; padding-bottom: 5px; }
        
        .scroll-row { display: flex; gap: 10px; overflow-x: auto; scrollbar-width: none; padding-bottom: 8px; align-items: center; }
        .scroll-row::-webkit-scrollbar { display: none; }
        
        .palette-dot { width: 22px; height: 22px; border-radius: 50%; border: 2px solid transparent; flex-shrink: 0; cursor: pointer; }
        .palette-dot.active { border-color: var(--main); transform: scale(1.15); box-shadow: 0 0 5px rgba(0,172,193,0.3); }
        .palette-dot.clear { background: #eee; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; color: #777; border-radius: 6px; width: 35px; }

        .filter-dot { padding: 4px 10px; border-radius: 12px; font-size: 0.65rem; background: #f2f2f2; color: #666; white-space: nowrap; border: 1px solid transparent; }
        .filter-dot.active { background: #e0f7f9; color: var(--main); border-color: var(--main); font-weight: bold; }

        /* å¡ç‰‡ä¸å‚ç›´å¸ƒå±€ */
        .container { padding: 12px; display: grid; grid-template-columns: repeat(var(--grid-cols), 1fr); gap: 12px; align-content: start; }
        .card { border-radius: 16px; padding: 1.1rem; position: relative; min-height: 180px; cursor: pointer; box-shadow: 0 6px 15px rgba(0,0,0,0.12); color: white; overflow: hidden; display: flex; flex-direction: column; transition: transform 0.1s; }
        .card:active { transform: scale(0.97); }
        .card .brand { font-size: var(--f-card); font-weight: 900; line-height: 1.1; margin-bottom: 2px; }
        .card .type { font-size: 0.85rem; font-weight: 600; opacity: 0.9; }
        .card .notes { font-size: 0.65rem; opacity: 0.8; margin-top: 5px; font-style: italic; background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px; display: inline-block; max-width: 92%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .card-footer { display: flex; flex-direction: column; margin-top: auto; padding-top: 12px; gap: 12px; }
        .action-area { display: flex; flex-direction: column; gap: 8px; width: 100%; }
        .action-btn { width: 100%; background: rgba(128,128,128,0.1); border: 1.5px solid currentColor; color: inherit; border-radius: 8px; padding: 10px 2px; font-size: 0.75rem; font-weight: 900; white-space: nowrap; text-align: center; opacity: 0.95; }
        .card .count { font-size: 2rem; font-weight: 900; line-height: 1; text-align: right; width: 100%; display: flex; align-items: baseline; justify-content: flex-end; }
        .card .count::after { content: 'å·'; font-size: 0.75rem; font-weight: normal; margin-left: 4px; opacity: 0.8; }

        /* å¼¹çª—åˆ†å±‚æ ‡å‡† */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        #warnModal { z-index: 2000; }
        .modal-content { background: white; width: 90%; max-width: 400px; border-radius: 26px; padding: 28px; color: #333; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
        .btn-row { display: flex; gap: 12px; margin-top: 18px; }
        .btn { flex: 1; padding: 15px; border-radius: 14px; border: none; cursor: pointer; font-size: 1rem; font-weight: bold; }
        .btn-main { background: var(--main); color: white; }
        .btn-cancel { background: #f5f5f5; color: #666; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        
        .btn-hold-init { position: relative; width: 100%; background: transparent; border: 1.5px solid var(--danger); color: var(--danger); border-radius: 12px; padding: 14px; font-size: 0.9rem; font-weight: bold; overflow: hidden; cursor: pointer; }
        #holdProgress { position: absolute; left: 0; top: 0; height: 100%; width: 0%; background: rgba(255,82,82,0.15); transition: width 0.1s linear; }

        .fab { position: fixed; bottom: 25px; right: 25px; width: 68px; height: 68px; background: var(--main); color: white; border-radius: 50%; border: none; font-size: 38px; box-shadow: 0 8px 20px rgba(0,172,193,0.4); z-index: 99; display: flex; align-items: center; justify-content: center; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .tag { background: #f0f0f0; color: #555; padding: 8px 16px; border-radius: 20px; font-size: 0.78rem; border: 1px solid #e0e0e0; display: flex; align-items: center; cursor: pointer; user-select: none; transition: all 0.2s; }
        .tag.active-touch { background: #d0d0d0; opacity: 0.5; transform: scale(0.9); }

        .settings-group { grid-column: span var(--grid-cols); background: white; border-radius: 18px; padding: 22px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.04); border: 1px solid #f0f0f0; }
        .settings-title { font-size: 1rem; font-weight: bold; margin-bottom: 18px; border-left: 5px solid var(--main); padding-left: 12px; color: #444; }
        .sync-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1.5px solid #eee; border-radius: 12px; font-size: 0.85rem; box-sizing: border-box; background: #fafafa; }
        .select-picker { display: flex; gap: 10px; flex-wrap: wrap; }
        .select-option { flex: 1; min-width: 75px; padding: 12px; border: 1.5px solid #f0f0f0; border-radius: 12px; text-align: center; font-size: 0.85rem; cursor: pointer; }
        .select-option.active { border-color: var(--main); background: #f0fbfc; color: var(--main); font-weight: bold; }
    </style>
</head>
<body>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('sealed')">æ€»åº“å­˜æ¸…å•<span id="cnt-sealed" class="tab-count">0</span></button>
    <button class="tab-btn" onclick="switchTab('inuse')">æ­£åœ¨ä½¿ç”¨<span id="cnt-inuse" class="tab-count">0</span></button>
    <button class="tab-btn" onclick="switchTab('opened')">å¤‡ç”¨å¼€å¯åº“<span id="cnt-opened" class="tab-count">0</span></button>
    <button class="tab-btn" onclick="switchTab('finished')">æ¶ˆè€—ç»“ç®—ç»Ÿè®¡<span id="cnt-finished" class="tab-count">0</span></button>
    <button class="tab-btn" onclick="switchTab('settings')">âš™ï¸ ç³»ç»Ÿè®¾ç½®</button>
</div>

<div id="searchBox" class="search-container">
    <div class="search-row">
        <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” 3D-FIMS æ£€ç´¢ä¸­å¿ƒ..." oninput="render()">
        <div id="filterBtn" class="filter-toggle" onclick="toggleFilterTray()">âš™ï¸</div>
    </div>
    <div id="filterTray" class="filter-tray">
        <div id="paletteBar" class="scroll-row" style="border-bottom:1px dashed #eee; margin-bottom:8px;"></div>
        <div id="filterDots" class="scroll-row"></div>
    </div>
</div>

<div id="content" class="container"></div>

<div id="warnModal" class="modal"><div class="modal-content" style="text-align:center;"><div id="warnIcon" style="font-size:55px;">âš ï¸</div><div id="warnTitle" style="font-weight:bold;font-size:1.2rem;margin:10px 0;">3D-FIMS æç¤º</div><p id="warnMsg" style="color:#666; font-size:0.95rem; margin-bottom:28px; line-height:1.6;"></p><div id="btnContainer" class="btn-row"><button class="btn" id="warnLeftBtn"></button><button class="btn" id="warnRightBtn"></button></div></div></div>

<div id="newModal" class="modal"><div class="modal-content"><div id="modalActionTitle" style="font-weight:bold;font-size:1.2rem;text-align:center;margin-bottom:18px;">3D-FIMS è€—æå…¥åº“</div>
    <div style="margin-bottom:12px;"><label style="font-size:0.75rem;color:#999;">ç”Ÿäº§å“ç‰Œ</label><input type="text" id="inBrand" class="sync-input"><div id="brandTags" class="tag-container"></div></div>
    <div style="margin-bottom:12px;"><label style="font-size:0.75rem;color:#999;">æè´¨ç±»å‹</label><input type="text" id="inType" class="sync-input"><div id="typeTags" class="tag-container"></div></div>
    <div style="margin-bottom:12px;"><label style="font-size:0.75rem;color:#999;">è¡¥å……è¯´æ˜ (å¤‡æ³¨)</label><input type="text" id="inNotes" placeholder="ç‹¬ç«‹å±æ€§æ ‡è®°" class="sync-input"></div>
    <div style="margin-bottom:12px;"><label style="font-size:0.75rem;color:#999;">è‰²å—æ ‡è¯†</label><input type="color" id="inColor" value="#00acc1" style="width:100%;height:45px;border:none;border-radius:8px;"></div>
    <div id="countRow" style="margin-bottom:12px;"><label style="font-size:0.75rem;color:#999;">å…¥åº“æ•°é‡</label><input type="number" id="inCount" value="1" min="1" oninput="if(this.value<1)this.value='1'" class="sync-input"></div>
    <div class="btn-row"><button class="btn btn-cancel" onclick="closeModals()">æ”¾å¼ƒ</button><button class="btn btn-main" id="saveNewBtn" onclick="saveNew()">ç¡®è®¤å…¥åº“</button></div>
</div></div>

<div id="adjustModal" class="modal"><div class="modal-content"><div style="font-weight:bold;font-size:1.2rem;text-align:center;margin-bottom:20px;">åº“å­˜é‡ç²¾ç¡®è°ƒæ•´</div>
    <div style="display:flex;align-items:center;justify-content:center;gap:20px;margin:25px 0;">
        <button style="width:65px;height:65px;font-size:2rem;border-radius:15px;border:1px solid #ddd;background:#fcfcfc" onclick="stepAdjust(-1)">-</button>
        <input type="number" id="adjNum" style="width:110px;height:65px;text-align:center;font-size:2rem;font-weight:bold;border:2px solid var(--main);border-radius:15px;outline:none;" oninput="if(this.value<1)this.value=1">
        <button style="width:65px;height:65px;font-size:2rem;border-radius:15px;border:1px solid #ddd;background:#fcfcfc" onclick="stepAdjust(1)">+</button>
    </div>
    <div style="text-align:center; margin-bottom:15px;"><a href="javascript:void(0)" style="color:var(--main); font-size:0.85rem; font-weight:bold; text-decoration:none;" onclick="openEditMode()">âœ ä¿®è®¢èµ„æ–™å±æ€§</a></div>
    <div class="btn-row"><button class="btn btn-cancel" onclick="closeModals()">è¿”å›</button><button class="btn btn-main" onclick="confirmAdj()">ä¿å­˜å˜åŠ¨</button></div>
    <button class="btn btn-danger" style="width:100%; margin-top:20px; font-size:0.9rem;" onclick="closeModals(); setTimeout(requestDelete, 100)">å½»åº•ç§»é™¤è¯¥è®°å½•</button>
</div></div>

<input type="file" id="localRestoreInput" style="display:none" accept=".json" onchange="importLocalBackup(this)">

<button id="fab" class="fab" onclick="openNewMode()">+</button>

<script>
    const MASTER_KEY = '3D_FIMS_STABLE_DB';
    const INITIAL_DB = {
        sealed: [], inuse: [], opened: [], finished: [], 
        config: { brands: ['æ‹“ç«¹', 'è‰ºæ¾', 'JAYO'], types: ['PLA', 'PETG', 'ABS', 'TPU'] },
        settings: { columns: 2, sortOrder: 'brand', ghToken: '', ghRepo: '', lastSync: 0 }, 
        lastBackup: 0, lastChange: 0
    };

    let db = JSON.parse(localStorage.getItem(MASTER_KEY)) || INITIAL_DB;
    let currentTab = 'sealed', activeIdx = null, activeFrom = '', activeFilter = '', activeColor = '', isEditMode = false;
    let holdTimer, holdProgress = 0, tagHoldTimer = null;

    function saveDB() { db.lastChange = Date.now(); localStorage.setItem(MASTER_KEY, JSON.stringify(db)); document.documentElement.style.setProperty('--grid-cols', db.settings.columns); }
    function getContrastColor(hex) { const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16); return (((r * 299) + (g * 587) + (b * 114)) / 1000 >= 128) ? '#000' : '#FFF'; }

    function toggleFilterTray() { const tray = document.getElementById('filterTray'); const btn = document.getElementById('filterBtn'); tray.classList.toggle('active'); btn.classList.toggle('active'); }

    function triggerLocalRestore() { document.getElementById('localRestoreInput').click(); }
    function importLocalBackup(input) {
        const file = input.files[0]; if (!file) return; const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result); if (!imported.sealed || !imported.config) throw new Error();
                const currentSync = { token: db.settings.ghToken, repo: db.settings.ghRepo };
                db = imported; db.settings.ghToken = currentSync.token; db.settings.ghRepo = currentSync.repo;
                saveDB(); render(); showNotice("3D-FIMS å¯¼å…¥æˆåŠŸ", "æœ¬åœ°å¤‡ä»½é•œåƒå·²å®Œæ•´æ³¨å…¥ç³»ç»Ÿç¯å¢ƒ");
            } catch(err) { showNotice("éæ³•æ–‡ä»¶", "æ‰€é€‰æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®æˆ–å·²æŸå", "error"); }
        }; reader.readAsText(file); input.value = "";
    }

    function exportLocalBackup() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db, null, 2));
        const downloadAnchor = document.createElement('a'); const timestamp = new Date().toLocaleString().replace(/[\/\s:]/g, '-');
        downloadAnchor.setAttribute("href", dataStr); downloadAnchor.setAttribute("download", `3D-FIMS_Backup_${timestamp}.json`);
        document.body.appendChild(downloadAnchor); downloadAnchor.click(); downloadAnchor.remove();
        showNotice("å¯¼å‡ºå®Œæˆ", "3D-FIMS ç‰©ç†ç¦»çº¿å­˜æ¡£å·²ç”Ÿæˆ");
    }

    function renderPalette() {
        const pBox = document.getElementById('paletteBar'); if (!pBox || currentTab === 'settings') return;
        const colors = [...new Set(db[currentTab].map(i => i.color))];
        pBox.innerHTML = `<div class="palette-dot clear" onclick="setColorFilter('')">é‡ç½®</div>` + 
            colors.map(c => `<div class="palette-dot ${activeColor===c?'active':''}" style="background:${c}" onclick="setColorFilter('${c}')"></div>`).join('');
    }

    function setColorFilter(c) { activeColor = c; render(); }

    function showNotice(title, msg, type = 'success') {
        const icon = type === 'success' ? 'âœ…' : 'âŒ'; const color = type === 'success' ? 'var(--success)' : 'var(--danger)';
        const btnClass = type === 'success' ? 'btn-success' : 'btn-danger';
        showCustomWarn(title, msg, "", "hide", null, "ç¡®å®š", btnClass, closeModals);
        document.getElementById('warnIcon').innerText = icon; document.getElementById('warnIcon').style.color = color;
    }

    async function githubSync(action) {
        if (currentTab === 'settings') { db.settings.ghToken = document.getElementById('ghToken').value.trim(); db.settings.ghRepo = document.getElementById('ghRepo').value.trim(); saveDB(); }
        const token = db.settings.ghToken, repo = db.settings.ghRepo;
        if (!token || !repo) { showNotice("é…ç½®ç¼ºå¤±", "è¯·å…ˆåœ¨ 3D-FIMS è®¾ç½®ä¸­è¡¥å…¨äº‘ç«¯åŒæ­¥ä¿¡æ¯", "error"); return; }
        try {
            const url = `https://api.github.com/repos/${repo}/contents/data.json`, headers = { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' };
            if (action === 'upload') {
                let cloudData = JSON.parse(JSON.stringify(db)); cloudData.settings.ghToken = ""; cloudData.settings.ghRepo = ""; 
                let sha = ""; const getRes = await fetch(url, { headers }); if (getRes.ok) { const meta = await getRes.json(); sha = meta.sha; }
                const res = await fetch(url, { method: 'PUT', headers, body: JSON.stringify({ message: "3D-FIMS Cloud Sync", content: btoa(unescape(encodeURIComponent(JSON.stringify(cloudData)))), sha })});
                if (res.ok) { db.settings.lastSync = Date.now(); saveDB(); render(); showNotice("3D-FIMS åŒæ­¥æˆåŠŸ", "æ•°æ®å·²ä¸Šä¼ è‡³ GitHub ä¸“ä¸šé•œåƒåº“"); } else throw new Error();
            } else {
                const res = await fetch(url, { headers });
                if (res.ok) { const data = await res.json(); const remote = JSON.parse(decodeURIComponent(escape(atob(data.content)))); remote.settings.ghToken = db.settings.ghToken; remote.settings.ghRepo = db.settings.ghRepo; db = remote; saveDB(); render(); showNotice("3D-FIMS æ¢å¤æˆåŠŸ", "å·²åŒæ­¥æœ€æ–°äº‘ç«¯æ•°æ®é•œåƒ"); } else showNotice("åŒæ­¥å¼‚å¸¸", "äº‘ç«¯æœªå‘ç°æœ‰æ•ˆæ•°æ®", "error");
            }
        } catch(e) { showNotice("3D-FIMS é€šä¿¡å¤±è´¥", "ç½‘ç»œæˆ–ä»¤ç‰Œæƒé™å¼‚å¸¸", "error"); }
    }

    function renderFilters() {
        const fBox = document.getElementById('filterDots'); if (!fBox || currentTab === 'settings') return;
        const types = ['å…¨éƒ¨', ...db.config.types]; const counts = {};
        db[currentTab].forEach(item => { counts[item.type] = (counts[item.type] || 0) + item.count; });
        fBox.innerHTML = types.map(t => {
            const num = t === 'å…¨éƒ¨' ? db[currentTab].reduce((s,i)=>s+i.count,0) : (counts[t] || 0);
            if (num === 0 && t !== 'å…¨éƒ¨' && activeFilter !== t) return '';
            return `<div class="filter-dot ${activeFilter === t || (!activeFilter && t === 'å…¨éƒ¨') ? 'active' : ''}" onclick="setFilter('${t}')">${t} Â· ${num}</div>`;
        }).join('');
    }

    function setFilter(f) { activeFilter = f === 'å…¨éƒ¨' ? '' : f; render(); }

    function render() {
        const container = document.getElementById('content'); const searchBox = document.getElementById('searchBox');
        const term = document.getElementById('searchInput').value.toLowerCase();
        container.innerHTML = ''; updateCounts(); document.documentElement.style.setProperty('--grid-cols', db.settings.columns);
        const isSet = currentTab === 'settings'; document.getElementById('fab').style.display = isSet ? 'none' : 'flex'; searchBox.style.display = isSet ? 'none' : 'block';

        if (isSet) {
            const syncTime = db.settings.lastSync ? new Date(db.settings.lastSync).toLocaleString() : 'ä»æœªå¤‡ä»½';
            container.innerHTML = `<div class="settings-group"><div class="settings-title">ğŸ¨ ç•Œé¢æ˜¾ç¤ºè§„æ ¼</div><div class="select-picker">${[1,2,3].map(n => `<div class="select-option ${db.settings.columns==n?'active':''}" onclick="updateCols(${n})">${n} åˆ—æ˜¾ç¤º</div>`).join('')}</div></div>
                <div class="settings-group"><div class="settings-title">ğŸ“Š è€—ææ’åºé€»è¾‘</div><div class="select-picker"><div class="select-option ${db.settings.sortOrder=='brand'?'active':''}" onclick="updateSort('brand')">å“ç‰Œä¼˜å…ˆ</div><div class="select-option ${db.settings.sortOrder=='type'?'active':''}" onclick="updateSort('type')">æè´¨ä¼˜å…ˆ</div><div class="select-option ${db.settings.sortOrder=='count'?'active':''}" onclick="updateSort('count')">æ•°é‡ä¼˜å…ˆ</div></div></div>
                <div class="settings-group"><div class="settings-title">â˜ï¸ 3D-FIMS äº‘ç«¯åŒæ­¥</div><input type="password" id="ghToken" class="sync-input" value="${db.settings.ghToken}" placeholder="GitHub Token (ghp_...)"><input type="text" id="ghRepo" class="sync-input" value="${db.settings.ghRepo}" placeholder="ä»“åº“è·¯å¾„ (ä¾‹: wyj20/3D-FIMS)">
                <div style="font-size:0.65rem; color:#999; margin-bottom:12px; text-align:right;">ğŸ•’ ä¸Šæ¬¡äº‘åŒæ­¥ï¼š${syncTime}</div>
                <div style="display:flex; gap:12px;"><button class="btn btn-main" style="font-size:0.85rem;" onclick="githubSync('upload')">â†‘ ä¸Šä¼ åŒæ­¥</button><button class="btn btn-cancel" style="font-size:0.85rem; border:1px solid #ddd;" onclick="githubSync('download')">â†“ ä¸‹è½½åŒæ­¥</button></div></div>
                <div class="settings-group"><div class="settings-title">ğŸ’¾ 3D-FIMS ç¦»çº¿å®‰å…¨å­˜æ¡£</div><div style="display:flex; gap:12px;"><button class="btn btn-cancel" style="width:100%; border:1.5px solid var(--main); color:var(--main); font-size:0.85rem;" onclick="exportLocalBackup()">å¯¼å‡ºç¦»çº¿å­˜æ¡£</button><button class="btn btn-cancel" style="width:100%; border:1.5px solid var(--main); color:var(--main); font-size:0.85rem;" onclick="triggerLocalRestore()">å¯¼å…¥ç¦»çº¿å­˜æ¡£</button></div></div>
                <div class="settings-group"><div class="settings-title">âš™ï¸ å±é™©åŒºåŸŸï¼š3D-FIMS ç»´æŠ¤</div><button class="btn-hold-init" id="initBtn" onmousedown="startHold()" onmouseup="endHold()" ontouchstart="startHold()" ontouchend="endHold()"><div id="holdProgress"></div><span style="position:relative;z-index:1">é•¿æŒ‰ 3 ç§’åˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒ</span></button></div>`;
            return;
        }

        renderFilters(); renderPalette();
        if (currentTab === 'finished') { container.innerHTML = `<div style="grid-column: span var(--grid-cols); text-align:center; padding: 20px 0;"><div style="font-size:3.5rem; font-weight:900; color:var(--main);">${db.finished.reduce((s,i)=>s+i.count,0)}</div><p style="color:#666; font-weight:bold; margin-bottom:15px;">å…¨å‘¨æœŸç´¯è®¡æ¶ˆè€—æ€»é‡</p><button class="btn btn-danger-outline" style="font-size:0.8rem; padding:8px 25px; border-radius:10px; width:auto; border:1.5px solid var(--danger); background:none; color:var(--danger)" onclick="requestClearFinished()">é‡ç½®ç»“ç®—è®°å½•</button></div>`; }
        
        let listData = db[currentTab] || [];
        let sorted = [...listData].sort((a,b) => {
            const o = db.settings.sortOrder;
            if(o === 'type') return (a.type||"").localeCompare(b.type||"",'zh') || (a.brand||"").localeCompare(b.brand||"",'zh');
            if(o === 'count') return (b.count - a.count) || (a.brand||"").localeCompare(b.brand||"",'zh');
            return (a.brand||"").localeCompare(b.brand||"",'zh') || (a.type||"").localeCompare(b.type||"",'zh');
        });

        sorted.forEach(item => {
            try {
                if(activeFilter && item.type !== activeFilter) return;
                if(activeColor && item.color !== activeColor) return;
                if(!item.brand.toLowerCase().includes(term) && !item.type.toLowerCase().includes(term) && !(item.notes||"").toLowerCase().includes(term)) return;
                const realIdx = db[currentTab].indexOf(item), txtC = getContrastColor(item.color || "#00acc1");
                const card = document.createElement('div'); card.className = 'card'; card.style.backgroundColor = item.color || "#00acc1"; card.style.color = txtC;
                card.onclick = () => { activeIdx = realIdx; activeFrom = currentTab; if(currentTab==='finished') requestDelete(); else { document.getElementById('adjNum').value = item.count; showModal('adjustModal'); } };
                let btns = ''; const btnS = `style="color:${txtC}; border-color:${txtC}"`;
                if(currentTab === 'sealed') btns = `<button class="action-btn" ${btnS} onclick="event.stopPropagation(); checkUnseal(${realIdx})">å‡ºåº“å¼€å¯</button>`;
                else if(currentTab === 'inuse') btns = `<button class="action-btn" ${btnS} onclick="event.stopPropagation(); move(${realIdx},'inuse','opened')">ç¦»æœºå…¥åº“</button><button class="action-btn" ${btnS} onclick="event.stopPropagation(); confirmFinish(${realIdx},'inuse')">è€—å°½ç»“å­˜</button>`;
                else if(currentTab === 'opened') btns = `<button class="action-btn" ${btnS} onclick="event.stopPropagation(); move(${realIdx},'opened','inuse')">è£…è½½ä¸Šæœº</button><button class="action-btn" ${btnS} onclick="event.stopPropagation(); confirmFinish(${realIdx},'opened')">è€—å°½ç»“å­˜</button>`;
                card.innerHTML = `<div class="brand">${item.brand}</div><div class="type">${item.type}</div>${item.notes?`<div class="notes"># ${item.notes}</div>`:''}<div class="card-footer"><div class="action-area">${btns}</div><div class="count">${item.count}</div></div>`;
                container.appendChild(card);
            } catch(e) {}
        });
        renderTags();
    }

    function handleTagTouch(cat, val, element) {
        let isLongPress = false;
        const start = (e) => { isLongPress = false; element.classList.add('active-touch'); tagHoldTimer = setTimeout(() => { isLongPress = true; requestDelTag(cat, val); element.classList.remove('active-touch'); }, 750); };
        const end = () => { clearTimeout(tagHoldTimer); element.classList.remove('active-touch'); if (!isLongPress) setIn('in' + cat, val); };
        element.ontouchstart = start; element.ontouchend = end; element.onmousedown = start; element.onmouseup = end; element.oncontextmenu = (e) => e.preventDefault();
    }

    function requestDelTag(c, v) {
        document.getElementById('warnIcon').innerText = 'âš ï¸'; document.getElementById('warnIcon').style.color = 'var(--warn)';
        showCustomWarn("ç®¡ç† 3D-FIMS å±æ€§", `ç¡®å®šè¦æ°¸ä¹…ç§»é™¤ [${v}] å—ï¼Ÿ`, "æ”¾å¼ƒ", "btn-cancel", closeModals, "ç¡®å®šåˆ é™¤", "btn-danger", () => {
            let l = c === 'Brand' ? db.config.brands : db.config.types; let i = l.indexOf(v); if (i > -1) l.splice(i, 1); saveDB(); renderTags(); closeModals();
        });
    }

    function renderTags() {
        const build = (cat, list) => {
            const html = list.map(v => `<span class="tag" id="tag-${cat}-${v.replace(/\s+/g,'_')}">${v}</span>`).join('') + `<span class="tag" style="border-style:dashed;color:var(--main);background:white;" onclick="addTag('${cat}')">+</span>`;
            setTimeout(() => { list.forEach(v => { const el = document.getElementById(`tag-${cat}-${v.replace(/\s+/g,'_')}`); if (el) handleTagTouch(cat, v, el); }); }, 0);
            return html;
        };
        if(document.getElementById('brandTags')) document.getElementById('brandTags').innerHTML = build('Brand', db.config.brands);
        if(document.getElementById('typeTags')) document.getElementById('typeTags').innerHTML = build('Type', db.config.types);
    }

    function startHold() { holdProgress = 0; holdTimer = setInterval(() => { holdProgress += 3.33; document.getElementById('holdProgress').style.width = holdProgress + '%'; if (holdProgress >= 100) { clearInterval(holdTimer); endHold(); requestReset(); } }, 100); }
    function endHold() { clearInterval(holdTimer); if (holdProgress < 100) { holdProgress = 0; document.getElementById('holdProgress').style.width = '0%'; } }
    function openNewMode() { isEditMode = false; document.getElementById('modalActionTitle').innerText = '3D-FIMS è€—æå…¥åº“'; document.getElementById('saveNewBtn').innerText = 'ç¡®è®¤å…¥åº“'; document.getElementById('countRow').style.display = 'block'; showModal('newModal'); }
    function openEditMode() { isEditMode = true; closeModals(); const item = db[activeFrom][activeIdx]; document.getElementById('inBrand').value = item.brand; document.getElementById('inType').value = item.type; document.getElementById('inNotes').value = item.notes || ''; document.getElementById('inColor').value = item.color; document.getElementById('modalActionTitle').innerText = '3D-FIMS èµ„æ–™ä¿®è®¢'; document.getElementById('saveNewBtn').innerText = 'ä¿å­˜ä¿®è®¢'; document.getElementById('countRow').style.display = 'none'; showModal('newModal'); }
    function saveNew() {
        const b = document.getElementById('inBrand').value.trim(), t = document.getElementById('inType').value.trim(), c = document.getElementById('inColor').value, nts = document.getElementById('inNotes').value.trim();
        if (!b || !t) return; if (!db.config.brands.includes(b)) db.config.brands.push(b); if (!db.config.types.includes(t)) db.config.types.push(t);
        if (isEditMode) db[activeFrom][activeIdx] = { ...db[activeFrom][activeIdx], brand: b, type: t, color: c, notes: nts };
        else { let n = parseInt(document.getElementById('inCount').value) || 1; let exist = db.sealed.find(i => i.brand === b && i.type === t && i.color === c && i.notes === nts); if (exist) exist.count += n; else db.sealed.push({ brand: b, type: t, color: c, count: n, notes: nts }); }
        saveDB(); render(); closeModals(); document.getElementById('inBrand').value = ''; document.getElementById('inType').value = ''; document.getElementById('inNotes').value = ''; document.getElementById('inCount').value = '1';
    }

    function requestReset() { document.getElementById('warnIcon').innerText = 'âš ï¸'; document.getElementById('warnIcon').style.color = 'var(--warn)'; showCustomWarn("ç³»ç»Ÿåˆå§‹åŒ–", "è¯¥æ“ä½œå°†æŠ¹é™¤æ‰€æœ‰ 3D-FIMS æœ¬åœ°æ•°æ®ã€‚ç¡®è®¤ï¼Ÿ", "æ”¾å¼ƒ", "btn-cancel", closeModals, "ç¡®è®¤é‡ç½®", "btn-danger", () => { db = JSON.parse(JSON.stringify(INITIAL_DB)); saveDB(); render(); closeModals(); showNotice("3D-FIMS é‡ç½®æˆåŠŸ", "ç³»ç»Ÿç¯å¢ƒå·²æ¢å¤å‡ºå‚çŠ¶æ€"); }); }
    function requestClearFinished() { document.getElementById('warnIcon').innerText = 'âš ï¸'; document.getElementById('warnIcon').style.color = 'var(--warn)'; showCustomWarn("å½»åº•æ¸…ç©ºè®°å½•", "ç¡®å®šè¦æŠ¹é™¤æ‰€æœ‰ç»“ç®—ç»Ÿè®¡å—ï¼Ÿ", "å–æ¶ˆ", "btn-cancel", closeModals, "ç¡®å®šæ¸…ç©º", "btn-danger", () => { db.finished = []; saveDB(); render(); closeModals(); }); }
    function requestDelete() { const item = db[activeFrom][activeIdx]; document.getElementById('warnIcon').innerText = 'âš ï¸'; document.getElementById('warnIcon').style.color = 'var(--warn)'; showCustomWarn("è®°å½•ç§»é™¤", `ç¡®å®šæ°¸ä¹…ç§»é™¤è®°å½•ã€${item.brand} ${item.type}ã€‘ï¼Ÿ`, "å–æ¶ˆ", "btn-cancel", closeModals, "ç¡®å®šç§»é™¤", "btn-danger", () => { db[activeFrom].splice(activeIdx, 1); saveDB(); render(); closeModals(); }); }
    function confirmAdj() { let n = parseInt(document.getElementById('adjNum').value); if (isNaN(n) || n < 1) n = 1; db[activeFrom][activeIdx].count = n; saveDB(); render(); closeModals(); }
    function checkUnseal(idx) { let item = db.sealed[idx]; let dup = db.inuse.concat(db.opened).find(i => i.brand === item.brand && i.type === item.type && i.color === item.color); if (dup) { document.getElementById('warnIcon').innerText = 'âš ï¸'; document.getElementById('warnIcon').style.color = 'var(--warn)'; showCustomWarn("3D-FIMS çŠ¶æ€é¢„è­¦", "ç›¸åŒè§„æ ¼è€—æå·²åœ¨å¼€å¯çŠ¶æ€ï¼Œç¡®è®¤é‡å¤å¼€å¯ï¼Ÿ", "æ”¾å¼ƒ", "btn-cancel", closeModals, "ç¡®è®¤å¼€å¯", "btn-main", () => { doUnseal(idx); }); } else doUnseal(idx); }
    function doUnseal(idx) { let item = db.sealed[idx]; item.count--; if(item.count<=0) db.sealed.splice(idx,1); let exist = db.inuse.find(i=>i.brand===item.brand && i.type===item.type && i.color===item.color && i.notes===item.notes); if(exist) exist.count++; else db.inuse.push({...item, count:1}); saveDB(); render(); closeModals(); }
    function confirmFinish(idx, f) { activeIdx = idx; activeFrom = f; document.getElementById('warnIcon').innerText = 'ğŸ“¦'; document.getElementById('warnIcon').style.color = 'var(--main)'; showCustomWarn("3D-FIMS ç»“ç®—ç¡®è®¤", "è¯·é€‰æ‹©æœ¬æ‰¹æ¬¡ç»“ç®—æ–¹å¼ï¼š", "å…¨é¢æ ¸é”€", "btn-danger", () => { doFinish('all'); }, "æ ¸é”€ 1 å·", "btn-main", () => { doFinish(1); }); }
    function doFinish(m) { let item = db[activeFrom][activeIdx], n = (m===1)?1:item.count; let exist = db.finished.find(i => i.brand === item.brand && i.type === item.type && i.color === item.color && i.notes === item.notes); if(exist) exist.count += n; else db.finished.push({...item, count:n}); if(m===1) { item.count--; if(item.count<=0) db[activeFrom].splice(activeIdx,1); } else db[activeFrom].splice(activeIdx,1); saveDB(); render(); closeModals(); }
    function move(idx, f, t) { let item = db[f].splice(idx, 1)[0], exist = db[t].find(i=>i.brand===item.brand && i.type===item.type && i.color===item.color && i.notes===item.notes); if(exist) exist.count += item.count; else db[t].push(item); saveDB(); render(); }
    function switchTab(t) { currentTab = t; document.getElementById('searchInput').value = ''; activeFilter = ''; activeColor = ''; document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); if(event) event.currentTarget.classList.add('active'); render(); }
    function showCustomWarn(t, m, lT, lC, lF, rT, rC, rF) { document.getElementById('warnTitle').innerText = t; document.getElementById('warnMsg').innerText = m; const lB = document.getElementById('warnLeftBtn'), rB = document.getElementById('warnRightBtn'); if(lC==="hide"){lB.style.display="none"}else{lB.style.display="block";lB.innerText = lT; lB.className = "btn " + lC; lB.onclick = lF;} rB.innerText = rT; rB.className = "btn " + rC; rB.onclick = rF; document.getElementById('warnModal').style.display = 'flex'; }
    function updateSort(v) { db.settings.sortOrder = v; saveDB(); render(); }
    function updateCols(n) { db.settings.columns = n; saveDB(); render(); }
    function addTag(c) { let v = prompt("3D-FIMS å½•å…¥æ–°å±æ€§:"); if(v) { let l = c==='Brand'?db.config.brands:db.config.types; if(!l.includes(v))l.push(v); renderTags(); saveDB(); } }
    function setIn(id, v) { document.getElementById(id).value = v; }
    function stepAdjust(v) { let el = document.getElementById('adjNum'); el.value = Math.max(1, (parseInt(el.value)||1)+v); }
    function updateCounts() { ['sealed','inuse','opened','finished'].forEach(k => { const el = document.getElementById('cnt-'+k); if(el) el.innerText = db[k].reduce((s,i)=>s+(parseInt(i.count)||0),0); }); }
    function showModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
    render();
</script>
</body>
</html>
