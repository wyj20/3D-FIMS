<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D-FIMS Core Next v2.11</title>
    <style>
        :root {
            --main: #00acc1; --bg: #f8f9fa; --nav: #212121; 
            --danger: #ff5252; --warn: #ff9800; --success: #4caf50;
            --card-radius: 16px; --panel-radius: 24px;
            --f-base: clamp(14px, 4vw, 18px);
            --grid-gap: 12px; --grid-cols: 2;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: #333; -webkit-tap-highlight-color: transparent; }
        body.modal-lock { overflow: hidden !important; touch-action: none; height: 100vh; }

        /* å¯¼èˆªç³»ç»Ÿ */
        .fims-nav { display: flex; background: var(--nav); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .nav-item { flex: 1; padding: 12px 2px; color: #888; border: none; background: none; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative; transition: 0.2s; }
        .nav-item.active { color: white; border-bottom: 3px solid var(--main); font-weight: bold; }
        .nav-badge { font-size: 0.65rem; opacity: 0.6; margin-top: 3px; font-weight: normal; }
        .sync-status { position: absolute; top: 8px; right: 20%; width: 6px; height: 6px; border-radius: 50%; background: #555; border: 1px solid #333; transition: 0.3s; }
        .sync-status.active { background: var(--success); box-shadow: 0 0 5px var(--success); }
        .sync-status.working { background: var(--warn); animation: pulse 1s infinite; }
        .sync-status.error { background: var(--danger); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* æ …æ ¼å¼•æ“ */
        .fims-container { padding: var(--grid-gap); display: grid; gap: var(--grid-gap); align-content: start; }
        .view-inventory { grid-template-columns: repeat(var(--grid-cols), minmax(0, 1fr)); }
        .view-settings { grid-template-columns: 1fr; }

        /* è€—æå¡ç‰‡ */
        .fims-card { 
            border-radius: var(--card-radius); padding: 1.1rem; min-height: 175px; color: white; 
            display: flex; flex-direction: column; box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
            transition: 0.1s; cursor: pointer; overflow: hidden; container-type: inline-size;
            position: relative;
        }
        .fims-card:active { transform: scale(0.97); }
        .card-content-layer { position: relative; z-index: 2; text-shadow: 0 1px 3px rgba(0,0,0,0.3); } 
        .card-brand { font-size: 1.2rem; font-weight: 900; line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-type { font-size: 0.85rem; opacity: 0.95; margin-top: 2px; }
        .card-notes { font-size: 0.65rem; opacity: 0.9; margin-top: 6px; background: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 4px; align-self: flex-start; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; backdrop-filter: blur(2px); }
        .card-count { font-size: clamp(1.2rem, 18cqw, 2.5rem); font-weight: 900; text-align: right; margin-top: auto; white-space: nowrap; line-height: 1; }
        .card-count::after { content: 'å·'; font-size: 0.4em; margin-left: 2px; font-weight: normal; vertical-align: middle; }
        
        .card-new-badge {
            position: absolute; top: 12px; right: 12px; z-index: 5;
            background: white; color: var(--danger);
            font-size: 0.65rem; font-weight: 900; padding: 2px 6px;
            border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            pointer-events: none;
        }

        .density-tiles .fims-card { aspect-ratio: 1/1 !important; min-height: 0 !important; justify-content: center; align-items: center; padding: 0.4rem !important; }
        .density-tiles .card-brand, .density-tiles .card-type, .density-tiles .card-notes { display: none !important; }
        .density-tiles .card-count { font-size: clamp(1rem, 25cqw, 2rem) !important; margin: 0 !important; width: 100%; text-align: center; }
        .density-tiles .card-new-badge { top: 4px; right: 4px; padding: 1px 4px; font-size: 0.5rem; }

        /* è®¾ç½®é¢æ¿ */
        .settings-block { background: white; border-radius: 18px; padding: 20px; margin-bottom: 15px; border: 1px solid #eee; }
        .settings-header { font-size: 1rem; font-weight: bold; margin-bottom: 15px; border-left: 5px solid var(--main); padding-left: 12px; }
        .control-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        
        .btn-hold-reset {
            position: relative; overflow: hidden; 
            background: white; border: 1.5px solid var(--danger); 
            color: var(--danger); font-weight: bold; 
            transition: 0.1s; user-select: none;
            display: flex; justify-content: center; align-items: center;
            padding: 15px; border-radius: 14px; width: 100%;
            cursor: pointer; box-sizing: border-box;
        }
        .hold-progress {
            position: absolute; top: 0; left: 0; bottom: 0; width: 0%; 
            background: rgba(255, 82, 82, 0.15); transition: width 0.1s linear; z-index: 0;
        }
        .hold-text { position: relative; z-index: 1; }

        /* å¼¹çª—ç³»ç»Ÿ */
        .fims-portal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); z-index: 1000; align-items: center; justify-content: center; }
        #warnPortal { z-index: 2000; }
        #finishPortal { z-index: 2100; }
        
        .portal-content { background: white; width: 92%; max-width: 420px; border-radius: var(--panel-radius); max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
        .p-header { padding: 20px 24px 10px; flex-shrink: 0; }
        .p-body { padding: 0 24px; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .p-footer { padding: 20px 24px; flex-shrink: 0; background: white; z-index: 10; border-top: 1px solid #f5f5f5; }

        .fims-btn { padding: 15px; border-radius: 14px; border: none; font-size: 1rem; font-weight: bold; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s; box-sizing: border-box; }
        .btn-main { background: var(--main); color: white; }
        .btn-ghost { background: #f2f2f2; color: #555; }
        .btn-danger { background: var(--danger); color: white; }
        .grid-btn { padding: 12px 2px; border: 1.5px solid #f0f0f0; border-radius: 12px; text-align: center; font-size: 0.8rem; background: #fff; cursor: pointer; }
        .grid-btn.active { border-color: var(--main); background: #f0fbfc; color: var(--main); font-weight: bold; }

        .form-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1.5px solid #eee; border-radius: 12px; box-sizing: border-box; background: #fafafa; font-size: 0.9rem; }
        .tag-row { display: flex; gap: 8px; margin: 5px 0 15px; overflow-x: auto; scrollbar-width: none; }
        .tag-pill { background: #f0f0f0; padding: 6px 12px; border-radius: 15px; font-size: 0.72rem; white-space: nowrap; border: 1px solid #e0e0e0; user-select: none; }
        
        .fab { position: fixed; bottom: 25px; right: 25px; width: 68px; height: 68px; background: var(--main); color: white; border-radius: 50%; border: none; font-size: 38px; box-shadow: 0 8px 20px rgba(0,172,193,0.4); z-index: 99; display: flex; align-items: center; justify-content: center; }

        .color-mode-bar { display: flex; background: #eee; padding: 4px; border-radius: 12px; margin-bottom: 12px; }
        .color-mode-btn { flex: 1; text-align: center; padding: 8px 0; font-size: 0.75rem; border-radius: 8px; cursor: pointer; color: #666; }
        .color-mode-btn.active { background: white; font-weight: bold; color: var(--main); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* v2.11 Toast Notification */
        .fims-toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(33, 33, 33, 0.95); color: white; padding: 12px 24px;
            border-radius: 50px; font-size: 0.9rem; font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 3000;
            opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none; /* å…³é”®ï¼šé˜²æ­¢é®æŒ¡æ“ä½œ */
        }
        .fims-toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
    </style>
</head>
<body>

    <nav class="fims-nav">
        <button class="nav-item active" id="nav-sealed" onclick="Router.go('sealed')">æ€»åº“<span id="cnt-sealed" class="nav-badge">0</span><div id="sync-dot" class="sync-status"></div></button>
        <button class="nav-item" id="nav-inuse" onclick="Router.go('inuse')">ä½¿ç”¨<span id="cnt-inuse" class="nav-badge">0</span></button>
        <button class="nav-item" id="nav-opened" onclick="Router.go('opened')">å¤‡ç”¨<span id="cnt-opened" class="nav-badge">0</span></button>
        <button class="nav-item" id="nav-finished" onclick="Router.go('finished')">è®°å½•<span id="cnt-finished" class="nav-badge">0</span></button>
        <button class="nav-item" id="nav-settings" onclick="Router.go('settings')">è®¾ç½®</button>
    </nav>

    <div id="app" class="fims-container view-inventory"></div>

    <div id="entryPortal" class="fims-portal"><div class="portal-content">
        <div class="p-header"><div id="entryTitle" style="font-weight:bold; text-align:center;">è€—æå…¥åº“ç™»è®°</div></div>
        <div class="p-body">
            <label style="font-size:0.7rem; color:#999;">ç”Ÿäº§å“ç‰Œ</label><input type="text" id="inBrand" class="form-input"><div id="brandTags" class="tag-row"></div>
            <label style="font-size:0.7rem; color:#999;">æè´¨ç±»å‹</label><input type="text" id="inType" class="form-input"><div id="typeTags" class="tag-row"></div>
            <label style="font-size:0.7rem; color:#999;">è‰²å½©æ¨¡å¼</label>
            <div class="color-mode-bar">
                <div class="color-mode-btn active" id="mode-solid" onclick="InventoryUI.switchColorMode('solid')">å•è‰²</div>
                <div class="color-mode-btn" id="mode-gradient" onclick="InventoryUI.switchColorMode('gradient')">æ¸å˜</div>
                <div class="color-mode-btn" id="mode-dual" onclick="InventoryUI.switchColorMode('dual')">åŒè‰²</div>
            </div>
            <label style="font-size:0.7rem; color:#999;">è§†è§‰é…è‰²</label>
            <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center;">
                <input type="color" id="inColorPicker1" style="width:50px; height:45px; border:none; background:none;" value="#00acc1">
                <span id="colorJoin" style="display:none; color:#999;">+</span>
                <input type="color" id="inColorPicker2" style="width:50px; height:45px; border:none; background:none; display:none;" value="#ff4081">
                <div style="flex:1; font-size:0.75rem; color:#999; text-align:right;">ç‚¹å‡»è‰²å—é€‰æ‹©</div>
            </div>
            <label style="font-size:0.7rem; color:#999;">å¤‡æ³¨ä¿¡æ¯</label><input type="text" id="inNotes" class="form-input" placeholder="é€‰å¡«ï¼Œå¦‚ï¼šå¤œå…‰è‰²">
            <label style="font-size:0.7rem; color:#999;">æ•°é‡</label><input type="number" id="inCount" value="1" class="form-input">
        </div>
        <div class="p-footer">
            <div style="display:flex; gap:12px;"><button class="fims-btn btn-ghost" onclick="Portal.closeAll()">æ”¾å¼ƒ</button><button class="fims-btn btn-main" onclick="InventoryUI.saveSubmit()">ä¿å­˜</button></div>
        </div>
    </div></div>

    <div id="warnPortal" class="fims-portal"><div class="portal-content" style="text-align:center;">
        <div class="p-header"><div id="warnIcon" style="font-size:50px">âš ï¸</div><div id="warnTitle" style="font-weight:bold; margin:10px 0;"></div></div>
        <div class="p-body"><p id="warnMsg" style="color:#666; font-size:0.9rem; margin-bottom:15px; line-height:1.5; white-space: pre-wrap;"></p></div>
        <div class="p-footer"><div style="display:flex; gap:12px;"><button class="fims-btn btn-ghost" id="warnLBtn"></button><button class="fims-btn" id="warnRBtn"></button></div></div>
    </div></div>

    <div id="finishPortal" class="fims-portal"><div class="portal-content" style="text-align:center;">
        <div class="p-header"><div style="font-size:50px">ğŸ“‰</div><div style="font-weight:bold; margin:10px 0;">æ¶ˆè€—ç»“ç®—</div></div>
        <div class="p-body"><p style="color:#666; font-size:0.9rem;">è¯·ç¡®è®¤è¯¥è€—æçš„æ¶ˆè€—çŠ¶æ€ã€‚</p></div>
        <div class="p-footer">
            <div style="display:flex; gap:12px; margin-bottom:12px;">
                <button class="fims-btn btn-danger" onclick="HubUI.doFinish(true)">å…¨é¢æ ¸é”€</button>
                <button class="fims-btn btn-main" onclick="HubUI.doFinish(false)">æ ¸é”€ 1 å·</button>
            </div>
            <button class="fims-btn btn-ghost" onclick="Portal.closeAll()">å–æ¶ˆè¿”å›</button>
        </div>
    </div></div>

    <div id="hubPortal" class="fims-portal"><div class="portal-content">
        <div class="p-body" style="padding-top:20px;">
            <div id="hubCardArea"></div>
            <div id="hubActionArea" style="display:flex; flex-direction:column; gap:10px; margin-top:20px;"></div>
            <div class="control-grid" style="margin-top:20px; padding-top:15px; border-top:1px dashed #eee">
                <button class="grid-btn" onclick="HubUI.toEditMode()">âœ ä¿®è®¢èµ„æ–™</button>
                <button class="grid-btn" style="color:var(--danger)" onclick="HubUI.requestDelete()">ğŸ—‘ï¸ åˆ é™¤è®°å½•</button>
            </div>
        </div>
        <div class="p-footer">
            <button class="grid-btn" style="width:100%; padding:15px;" onclick="Portal.closeAll()">âœ–ï¸ å…³é—­</button>
        </div>
    </div></div>

    <input type="file" id="importInput" style="display:none" onchange="SyncCenter.importFile(this)">
    <button class="fab" id="mainFab" onclick="InventoryUI.openAdd()">+</button>

<script>
    /* v2.11 Toast Module */
    const Toast = {
        show(msg) {
            const div = document.createElement('div');
            div.className = 'fims-toast';
            div.innerText = msg;
            document.body.appendChild(div);
            requestAnimationFrame(() => div.classList.add('show'));
            setTimeout(() => {
                div.classList.remove('show');
                setTimeout(() => div.remove(), 300);
            }, 2500);
        }
    };

    const Migrator = {
        fix(data) {
            const def = { inventory: { sealed: [], inuse: [], opened: [], finished: [] }, config: { brands: ['æ‹“ç«¹', 'è‰ºæ¾', 'JAYO', 'å“æ™®'], types: ['PLA', 'PETG', 'ABS'] }, settings: { columns: 2, density: 'standard', ghToken: '', ghRepo: '', sortOrder: 'count' } };
            if(!data.settings) data.settings = def.settings;
            if(!data.config) data.config = def.config;
            if(!data.inventory) data.inventory = def.inventory;
            if(!data.inventory.finished) data.inventory.finished = [];
            Object.keys(def.settings).forEach(k => { if(data.settings[k] === undefined) data.settings[k] = def.settings[k]; });
            return data;
        }
    };

    let RAW_DB = JSON.parse(localStorage.getItem('FIMS_NEXT_DB'));
    let STATE = RAW_DB ? Migrator.fix(RAW_DB) : Migrator.fix({}); 

    const Core = {
        save() { 
            localStorage.setItem('FIMS_NEXT_DB', JSON.stringify(STATE));
            document.documentElement.style.setProperty('--grid-cols', STATE.settings.columns);
            Router.updateCounts();
            SyncCenter.autoCloud();
        },
        moveItem(idx, from, to, all=false) {
            let item = STATE.inventory[from][idx];
            let num = all ? item.count : 1;
            item.count -= num;
            if(item.count <= 0) STATE.inventory[from].splice(idx, 1);
            
            let newItem = { ...item, count: num };
            if (to === 'finished') {
                newItem.origin = from; 
            } else if (from === 'finished') {
                if (item.origin && ['sealed','inuse','opened'].includes(item.origin)) to = item.origin;
                delete newItem.origin;
            }

            let exist = STATE.inventory[to].find(i => 
                i.brand === item.brand && i.type === item.type && i.notes === item.notes &&
                i.color === item.color && i.color2 === item.color2 && i.colorMode === item.colorMode
            );
            
            if(exist) exist.count += num; else STATE.inventory[to].push(newItem);
            this.save(); Router.render(); Portal.closeAll();
        },
        updateItem(idx, tab, newData) {
            STATE.inventory[tab][idx] = { ...STATE.inventory[tab][idx], ...newData };
            this.save(); Router.render(); Portal.closeAll();
        },
        deleteItem(idx, tab) {
            STATE.inventory[tab].splice(idx, 1);
            this.save(); Router.render(); Portal.closeAll();
        }
    };

    const SyncCenter = {
        setStatus(status) { const el = document.getElementById('sync-dot'); el.className = 'sync-status ' + status; },
        export() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(STATE)); a.download=`FIMS_${Date.now()}.json`; a.click(); },
        triggerImport() { document.getElementById('importInput').click(); },
        importFile(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.inventory && data.settings) {
                        // v2.11 å¼ºåˆ¶å±æ€§æ¸…æ´— + åŒé‡å¼‚æ­¥å¸§
                        Portal.closeAll(); 
                        document.body.removeAttribute('style'); // å¼ºåˆ¶ç§»é™¤é”æ­»å±æ€§
                        
                        requestAnimationFrame(() => {
                            setTimeout(() => { 
                                STATE = Migrator.fix(data); 
                                Core.save(); Router.render();
                                Toast.show("å¯¼å…¥æˆåŠŸï¼šæ•°æ®å·²æ¢å¤"); // ä½¿ç”¨ Toast ä»£æ›¿å¼¹çª—
                            }, 50);
                        });
                    } else throw new Error();
                } catch(err) { Toast.show("é”™è¯¯ï¼šæ–‡ä»¶æ ¼å¼æ— æ•ˆ"); }
            };
            reader.readAsText(file); input.value = '';
        },
        async autoCloud() {
            const { ghToken: t, ghRepo: r } = STATE.settings;
            if(!t || !r) return;
            this.setStatus('working'); 
            try {
                const url = `https://api.github.com/repos/${r}/contents/data.json`, headers = { 'Authorization': `token ${t}` };
                let sha = ""; const g = await fetch(url, { headers }); if(g.ok) sha = (await g.json()).sha;
                const res = await fetch(url, { method: 'PUT', headers, body: JSON.stringify({ message: "Sync", content: btoa(unescape(encodeURIComponent(JSON.stringify(STATE)))), sha })});
                if(res.ok) { this.setStatus('active'); setTimeout(()=>this.setStatus(''), 3000); } else throw new Error();
            } catch(e) { this.setStatus('error'); }
        }
    };

    const Router = {
        activeTab: 'sealed',
        go(tab) {
            this.activeTab = tab;
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-' + tab).classList.add('active');
            this.render();
        },
        render() {
            const app = document.getElementById('app');
            app.className = `fims-container view-${this.activeTab === 'settings' ? 'settings' : 'inventory'} density-${STATE.settings.density}`;
            document.getElementById('mainFab').style.display = this.activeTab === 'settings' ? 'none' : 'flex';
            
            const frag = document.createDocumentFragment();
            if (this.activeTab === 'settings') {
                const wrapper = document.createElement('div');
                SettingsUI.render(wrapper);
                frag.appendChild(wrapper);
            } else {
                InventoryUI.render(frag, this.activeTab);
            }
            app.innerHTML = '';
            app.appendChild(frag);
            this.updateCounts();
        },
        updateCounts() {
            ['sealed','inuse','opened','finished'].forEach(k => {
                const el = document.getElementById('cnt-'+k);
                if(el) el.innerText = STATE.inventory[k].reduce((s,i)=>s+(parseInt(i.count)||0), 0);
            });
        }
    };

    const InventoryUI = {
        editMode: false, editIdx: null, currentColorMode: 'solid',
        render(container, tab) {
            let list = [...STATE.inventory[tab]].sort((a,b) => {
                const o = STATE.settings.sortOrder;
                if(o==='count') return b.count - a.count;
                return (a.brand||'').localeCompare(b.brand||'');
            });
            list.forEach((item, idx) => {
                const card = document.createElement('div');
                card.className = 'fims-card';
                const bg = this.getBackgroundStyle(item.colorMode, item.color, item.color2);
                card.style.background = bg;
                
                let badge = '';
                if(item.isNew) badge = `<div class="card-new-badge">NEW</div>`;
                
                card.innerHTML = `${badge}<div class="card-content-layer"><div class="card-brand">${item.brand}</div><div class="card-type">${item.type}</div>${item.notes?`<div class="card-notes"># ${item.notes}</div>`:''}<div class="card-count">${item.count}</div></div>`;
                card.onclick = () => {
                    const realIdx = STATE.inventory[tab].indexOf(item);
                    HubUI.open(realIdx, tab);
                };
                container.appendChild(card);
            });
        },
        getBackgroundStyle(mode, c1, c2) {
            if(mode === 'gradient') return `linear-gradient(135deg, ${c1}, ${c2})`;
            if(mode === 'dual') return `linear-gradient(90deg, ${c1} 50%, ${c2} 50%)`;
            return c1;
        },
        switchColorMode(mode) {
            this.currentColorMode = mode;
            document.querySelectorAll('.color-mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('mode-'+mode).classList.add('active');
            const p2 = document.getElementById('inColorPicker2');
            const join = document.getElementById('colorJoin');
            if(mode === 'solid') { p2.style.display = 'none'; join.style.display = 'none'; }
            else { p2.style.display = 'block'; join.style.display = 'block'; }
        },
        openAdd() { 
            this.editMode = false; 
            document.getElementById('entryTitle').innerText = 'è€—æå…¥åº“ç™»è®°';
            ['inBrand','inType','inNotes'].forEach(id=>document.getElementById(id).value='');
            document.getElementById('inCount').value = 1;
            document.getElementById('inColorPicker1').value = '#00acc1';
            document.getElementById('inColorPicker2').value = '#ff4081';
            this.switchColorMode('solid');
            this.renderTagCloud(); Portal.open('entryPortal'); 
        },
        renderTagCloud() {
            const build = (cat, list, elId) => {
                document.getElementById(elId).innerHTML = list.map(v => `<div class="tag-pill" id="tag-${cat}-${v}">${v}</div>`).join('') + `<div class="tag-pill" style="color:var(--main); border-style:dashed" onclick="InventoryUI.newTag('${cat}')">+</div>`;
                list.forEach(v => {
                    const el = document.getElementById(`tag-${cat}-${v}`);
                    let timer;
                    el.ontouchstart = () => { timer = setTimeout(() => Portal.confirm("ç§»é™¤æ ‡ç­¾", `ç¡®å®šåˆ é™¤ [${v}]ï¼Ÿ`, "å–æ¶ˆ", Portal.closeWarn, "ç§»é™¤", () => { STATE.config[cat === 'Brand' ? 'brands' : 'types'].splice(list.indexOf(v), 1); Core.save(); InventoryUI.renderTagCloud(); Portal.closeWarn(); }), 750); };
                    el.ontouchend = () => { clearTimeout(timer); if(timer) document.getElementById('in'+cat).value = v; };
                });
            };
            build('Brand', STATE.config.brands, 'brandTags');
            build('Type', STATE.config.types, 'typeTags');
        },
        newTag(cat) { const v = prompt("æ–°æ ‡ç­¾åç§°:"); if(v){ STATE.config[cat==='Brand'?'brands':'types'].push(v); Core.save(); this.renderTagCloud(); } },
        saveSubmit() {
            const b = document.getElementById('inBrand').value.trim(), t = document.getElementById('inType').value.trim(), nts = document.getElementById('inNotes').value.trim();
            const c1 = document.getElementById('inColorPicker1').value, c2 = document.getElementById('inColorPicker2').value;
            const n = parseInt(document.getElementById('inCount').value);
            
            if(!b || !t) return Portal.confirm("ä¿¡æ¯ä¸å…¨", "è¯·è‡³å°‘å¡«å†™å“ç‰Œå’Œæè´¨ã€‚", "å¥½çš„", Portal.closeWarn, "", null);
            if(isNaN(n) || n < 1) return Portal.confirm("æ•°é‡é”™è¯¯", "å…¥åº“æ•°é‡è‡³å°‘ä¸º 1ã€‚", "å¥½çš„", Portal.closeWarn, "", null);

            if(!STATE.config.brands.includes(b)) STATE.config.brands.push(b);
            if(!STATE.config.types.includes(t)) STATE.config.types.push(t);

            const newData = { brand: b, type: t, color: c1, color2: c2, colorMode: this.currentColorMode, count: n, notes: nts };
            
            if(this.editMode) {
                Core.updateItem(this.editIdx, Router.activeTab, newData);
            } else {
                ['sealed','inuse','opened'].forEach(k => STATE.inventory[k].forEach(i => delete i.isNew));
                newData.isNew = true; 
                let exist = STATE.inventory.sealed.find(i => i.brand === b && i.type === t && i.color === c1 && i.color2 === c2 && i.colorMode === this.currentColorMode && i.notes === nts);
                if(exist) { exist.count += n; exist.isNew = true; } 
                else STATE.inventory.sealed.push(newData);
                Core.save(); Router.render(); Portal.closeAll();
            }
        }
    };

    const HubUI = {
        activeIdx: null, activeTab: null,
        open(idx, tab) {
            this.activeIdx = idx; this.activeTab = tab;
            const item = STATE.inventory[tab][idx];
            const bg = InventoryUI.getBackgroundStyle(item.colorMode, item.color, item.color2);
            const badge = item.isNew ? `<div class="card-new-badge" style="top:10px;right:10px;">NEW</div>` : '';
            document.getElementById('hubCardArea').innerHTML = `<div class="fims-card" style="background:${bg}; cursor:default;">${badge}<div class="card-content-layer"><div class="card-brand">${item.brand}</div><div class="card-type">${item.type}</div>${item.notes?`<div class="card-notes"># ${item.notes}</div>`:''}<div class="card-count">${item.count}</div></div></div>`;
            
            let btns = '';
            if(tab === 'sealed') btns = `<button class="fims-btn btn-main" onclick="HubUI.checkUnseal(${idx})">å‡ºåº“å¼€å¯</button>`;
            else if(tab === 'inuse') btns = `<button class="fims-btn btn-main" onclick="Core.moveItem(${idx},'inuse','opened')">å–ä¸‹å¤‡ç”¨</button><button class="fims-btn btn-danger" onclick="HubUI.openFinishModal()">è€—å°½æ ¸é”€</button>`;
            else if(tab === 'opened') btns = `<button class="fims-btn btn-main" onclick="Core.moveItem(${idx},'opened','inuse')">ä¸ŠæœºåŠ è½½</button><button class="fims-btn btn-danger" onclick="HubUI.openFinishModal()">è€—å°½æ ¸é”€</button>`;
            else if(tab === 'finished') {
                const origin = item.origin ? (item.origin==='inuse'?'ä½¿ç”¨ä¸­':'å¤‡ç”¨åº“') : 'æ€»åº“';
                btns = `<button class="fims-btn btn-main" onclick="Core.moveItem(${idx},'finished','sealed')">â™»ï¸ æ¢å¤è‡³ ${origin}</button>`;
            }
            
            document.getElementById('hubActionArea').innerHTML = btns;
            Portal.open('hubPortal');
        },
        checkUnseal(idx) {
            const item = STATE.inventory.sealed[idx];
            const inUseCount = STATE.inventory.inuse.filter(i => i.brand === item.brand && i.type === item.type && i.color === item.color).reduce((s,i)=>s+i.count,0);
            const openedCount = STATE.inventory.opened.filter(i => i.brand === item.brand && i.type === item.type && i.color === item.color).reduce((s,i)=>s+i.count,0);

            if (inUseCount > 0 || openedCount > 0) {
                const msg = `åŒè§„æ ¼è€—æï¼š\nä½¿ç”¨ä¸­ ${inUseCount} å· | å¤‡ç”¨ ${openedCount} å·\n\næ˜¯å¦ä»è¦å¼€å¯æ–°å·ï¼Ÿ`;
                Portal.confirm("é‡å¤å¼€å¯é¢„è­¦", msg, "å–æ¶ˆ", Portal.closeWarn, "å¼ºåˆ¶å¼€å¯", () => Core.moveItem(idx, 'sealed', 'inuse'));
            } else {
                Core.moveItem(idx, 'sealed', 'inuse');
            }
        },
        openFinishModal() { Portal.open('finishPortal'); },
        doFinish(all) { Core.moveItem(this.activeIdx, this.activeTab, 'finished', all); },
        requestDelete() {
            Portal.confirm("å½»åº•åˆ é™¤", "ç¡®å®šæ°¸ä¹…åˆ é™¤æ­¤æ¡è®°å½•å—ï¼Ÿä¸å¯æ¢å¤ã€‚", "å–æ¶ˆ", Portal.closeWarn, "åˆ é™¤", () => Core.deleteItem(this.activeIdx, this.activeTab));
        },
        toEditMode() {
            Portal.closeAll();
            const item = STATE.inventory[this.activeTab][this.activeIdx];
            InventoryUI.editMode = true;
            InventoryUI.editIdx = this.activeIdx;
            document.getElementById('entryTitle').innerText = 'ä¿®è®¢è€—æèµ„æ–™';
            document.getElementById('inBrand').value = item.brand;
            document.getElementById('inType').value = item.type;
            document.getElementById('inNotes').value = item.notes || '';
            document.getElementById('inColorPicker1').value = item.color;
            if(item.color2) document.getElementById('inColorPicker2').value = item.color2;
            document.getElementById('inCount').value = item.count;
            InventoryUI.switchColorMode(item.colorMode || 'solid');
            InventoryUI.renderTagCloud();
            setTimeout(() => Portal.open('entryPortal'), 50);
        }
    };

    const SettingsUI = {
        holdTimer: null, holdProgress: 0,
        render(app) {
            app.innerHTML = `
                <div class="settings-block"><div class="settings-header">ğŸ¨ ç•Œé¢è§„æ ¼</div><div class="control-grid">${[1,2,3,4,5,6].map(n=>`<div class="grid-btn ${STATE.settings.columns==n?'active':''}" onclick="SettingsUI.updateCols(${n})">${n}åˆ—</div>`).join('')}</div></div>
                <div class="settings-block"><div class="settings-header">ğŸ“ è§†è§‰å¯†åº¦</div><div class="control-grid">${['standard','compact','tiles'].map(d=>`<div class="grid-btn ${STATE.settings.density==d?'active':''}" onclick="SettingsUI.updateDensity('${d}')">${d=='tiles'?'è‰²å—':d=='compact'?'ç´§å‡‘':'æ ‡å‡†'}</div>`).join('')}</div></div>
                <div class="settings-block"><div class="settings-header">â˜ï¸ äº‘ç«¯åŒæ­¥ (GitHub)</div><input type="password" id="ghToken" class="form-input" value="${STATE.settings.ghToken}" placeholder="GitHub Token"><input type="text" id="ghRepo" class="form-input" value="${STATE.settings.ghRepo}" placeholder="ä»“åº“è·¯å¾„ (user/repo)"><button class="fims-btn btn-main" onclick="SyncCenter.autoCloud()">ç«‹å³æµ‹è¯•åŒæ­¥</button></div>
                <div class="settings-block"><div class="settings-header">ğŸ’¾ æ•°æ®ç®¡ç†</div><button class="fims-btn btn-ghost" onclick="SyncCenter.export()" style="margin-bottom:10px;">å¯¼å‡ºæœ¬åœ°å­˜æ¡£ (Backup)</button><button class="fims-btn btn-ghost" onclick="SyncCenter.triggerImport()">å¯¼å…¥æœ¬åœ°å­˜æ¡£ (Restore)</button></div>
                <div class="settings-block"><div class="settings-header">âš™ï¸ ç»´æŠ¤</div>
                    <div class="btn-hold-reset" onmousedown="SettingsUI.startHold()" ontouchstart="SettingsUI.startHold()" onmouseup="SettingsUI.endHold()" ontouchend="SettingsUI.endHold()">
                        <div id="holdBar" class="hold-progress"></div><span class="hold-text">é‡ç½®ç³»ç»Ÿ</span>
                    </div>
                </div>
            `;
        },
        updateCols(n) { STATE.settings.columns = n; Core.save(); Router.render(); },
        updateDensity(d) { STATE.settings.density = d; Core.save(); Router.render(); },
        startHold() {
            this.holdProgress = 0;
            this.holdTimer = setInterval(() => {
                this.holdProgress += 2;
                const bar = document.getElementById('holdBar');
                if(bar) bar.style.width = this.holdProgress + '%';
                if(this.holdProgress >= 100) {
                    this.endHold();
                    Portal.confirm("å±é™©æ“ä½œ", "ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å¹¶é‡ç½®ç³»ç»Ÿå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚", "å–æ¶ˆ", Portal.closeWarn, "ç¡®å®šé‡ç½®", () => { localStorage.clear(); location.reload(); });
                }
            }, 20);
        },
        endHold() {
            clearInterval(this.holdTimer);
            const bar = document.getElementById('holdBar');
            if(bar) bar.style.width = '0%';
        }
    };

    const Portal = {
        open(id) { document.getElementById(id).style.display = 'flex'; document.body.classList.add('modal-lock'); },
        closeAll() { 
            document.querySelectorAll('.fims-portal').forEach(p => p.style.display = 'none'); 
            // v2.11 å¼ºåˆ¶æ¸…ç†
            document.body.classList.remove('modal-lock'); 
            document.body.removeAttribute('style'); 
        },
        closeWarn() { document.getElementById('warnPortal').style.display = 'none'; },
        confirm(t, m, lT, lF, rT, rF) {
            document.getElementById('warnTitle').innerText = t; document.getElementById('warnMsg').innerText = m;
            const lB = document.getElementById('warnLBtn'), rB = document.getElementById('warnRBtn');
            lB.innerText = lT; lB.className = "fims-btn btn-ghost"; lB.onclick = lF;
            rB.innerText = rT; rB.className = rT ? "fims-btn btn-danger" : "fims-btn btn-ghost"; 
            if(rT) { rB.style.display='flex'; rB.onclick = rF; } else rB.style.display='none';
            this.open('warnPortal');
        }
    };
    
    // å¯åŠ¨
    document.documentElement.style.setProperty('--grid-cols', STATE.settings.columns);
    Router.updateCounts();
    Router.go('sealed');
</script>
</body>
</html>
